<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Influence Atlas - Context for expert authenticity</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
                <link rel="stylesheet" href="styles.css?v=7.2">
</head>
<body>
    <div class="container">
        <!-- Header - Full Width -->
        <div class="header">
            <h1>Influence Atlas</h1>
            <p>Context for expert authenticity</p>
        </div>

        <!-- Desktop Navigation - Enhanced -->
        <div class="desktop-nav">
            <div class="nav-left">
                <div class="selection-counter">
                    <div class="count-badge">
                        <span id="selected-count">0</span>
                    </div>
                    <span class="count-text">of</span>
                    <div class="count-badge">
                        <span id="total-count">256</span>
                    </div>
                    <span class="count-text">SELECTED</span>
                </div>
                <button id="clear-selections-btn" class="btn-clear" onclick="clearSelections()" disabled>CLEAR</button>
            </div>
            
            <div class="nav-separator-container">
                <div class="nav-separator"></div>
            </div>
            
            <div class="nav-center">
                <!-- Format Toggles with Actions -->
                <div class="format-toggles">
                    <div class="format-option">
                        <div class="radio-button checked">
                            <div class="radio-outer"></div>
                            <div class="radio-inner"></div>
                        </div>
                        <label for="format-markdown">MARKDOWN</label>
                    </div>
                    <div class="format-option">
                        <div class="radio-button">
                            <div class="radio-outer"></div>
                        </div>
                        <label for="format-json">JSON</label>
                    </div>
                    <div class="format-option">
                        <div class="radio-button">
                            <div class="radio-outer"></div>
                        </div>
                        <label for="format-agent">AGENT</label>
                    </div>
                </div>
                <button id="copy-selected-btn" class="btn-action" onclick="copySelected()" disabled>COPY</button>
                <button id="download-selected-btn" class="btn-action" onclick="downloadSelected()" disabled>DOWNLOAD</button>
            </div>
            
            <div class="nav-separator-container">
                <div class="nav-separator"></div>
            </div>
            
            <div class="nav-right">
                <div class="search-container">
                    <input type="text" id="search-filter" placeholder="Search Profiles" onkeyup="debouncedFilterProfiles()">
                </div>
            </div>
        </div>

        <!-- Mobile Filter Header -->
        <div class="mobile-filter-header">
            <button class="mobile-menu-toggle" onclick="toggleFilters()">☰ Filters</button>
        </div>

        <div class="main-content">
            <div class="filters-section">
                <div class="filters">
                <!-- Super Filters - Broad Categories -->
                <div class="filter-item super-filters">
                    <div class="filter-header" onclick="toggleFilter('super-filters')">
                        <span>Quick Categories</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div id="super-filters-content" class="filter-content super-filter-content">
                        <div class="super-filter-buttons">
                            <button class="super-filter-btn" onclick="applySuperFilter('Arts')">Arts</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Business')">Business</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Contemplative Psychology')">Contemplative Psychology</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Design')">Design</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Economics')">Economics</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Entrepreneurial')">Entrepreneurial</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Environmental')">Environmental</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('History')">History</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Investment')">Investment</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Marketing')">Marketing</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Math')">Math</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Medicine')">Medicine</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Meditation')">Meditation</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Mindfulness')">Mindfulness</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Motivation Coaching')">Motivation Coaching</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Music')">Music</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Philosophy')">Philosophy</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Psychology')">Psychology</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Public Policy')">Public Policy</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Science')">Science</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Technology')">Technology</button>
                            <button class="super-filter-btn" onclick="applySuperFilter('Writers')">Writers</button>
                            <button class="super-filter-btn" onclick="clearAllFilters()">Clear All</button>
                        </div>
                    </div>
                </div>
                
                <!-- Individual Collapsible Filters -->
                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('archetype-filter')">
                        <span>Archetype</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="archetype-filter-content">
                        <div class="filter-group">
                            <select id="archetype-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('domain-filter')">
                        <span>Domain</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="domain-filter-content">
                        <div class="filter-group">
                            <select id="domain-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('subdomain-filter')">
                        <span>Subdomain</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="subdomain-filter-content">
                        <div class="filter-group">
                            <select id="subdomain-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('trait-filter')">
                        <span>Psychological Traits</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="trait-filter-content">
                        <div class="filter-group">
                            <select id="trait-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('communication-filter')">
                        <span>Communication Style</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="communication-filter-content">
                        <div class="filter-group">
                            <select id="communication-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('sentence-structure-filter')">
                        <span>Sentence Structure</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="sentence-structure-filter-content">
                        <div class="filter-group">
                            <select id="sentence-structure-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('expertise-filter')">
                        <span>Domain Expertise</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="expertise-filter-content">
                        <div class="filter-group">
                            <select id="expertise-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('background-filter')">
                        <span>Background Context</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="background-filter-content">
                        <div class="filter-group">
                            <select id="background-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('behavior-filter')">
                        <span>Behavioral Patterns</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="behavior-filter-content">
                        <div class="filter-group">
                            <select id="behavior-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('problem-solving-filter')">
                        <span>Problem Solving</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="problem-solving-filter-content">
                        <div class="filter-group">
                            <select id="problem-solving-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('identifier-filter')">
                        <span>Unique Identifiers</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="identifier-filter-content">
                        <div class="filter-group">
                            <select id="identifier-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('temporal-filter')">
                        <span>Temporal Context</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="temporal-filter-content">
                        <div class="filter-group">
                            <select id="temporal-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('collaboration-filter')">
                        <span>Collaboration</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="collaboration-filter-content">
                        <div class="filter-group">
                            <select id="collaboration-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('cultural-filter')">
                        <span>Cultural Context</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="cultural-filter-content">
                        <div class="filter-group">
                            <select id="cultural-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('practical-filter')">
                        <span>Practical Application</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="practical-filter-content">
                        <div class="filter-group">
                            <select id="practical-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('communication-new-filter')">
                        <span>Communication</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="communication-new-filter-content">
                        <div class="filter-group">
                            <select id="communication-new-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('learning-filter')">
                        <span>Learning</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="learning-filter-content">
                        <div class="filter-group">
                            <select id="learning-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('values-filter')">
                        <span>Values</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="values-filter-content">
                        <div class="filter-group">
                            <select id="values-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <!-- Behavioral Humanism Filters -->
                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('bias-awareness-filter')">
                        <span>Bias Awareness</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="bias-awareness-filter-content">
                        <div class="filter-group">
                            <select id="bias-awareness-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('growth-motivation-filter')">
                        <span>Growth Motivation</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="growth-motivation-filter-content">
                        <div class="filter-group">
                            <select id="growth-motivation-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('cognitive-humanism-filter')">
                        <span>Cognitive Humanism</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="cognitive-humanism-filter-content">
                        <div class="filter-group">
                            <select id="cognitive-humanism-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('humanistic-cognition-filter')">
                        <span>Humanistic Cognition</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="humanistic-cognition-filter-content">
                        <div class="filter-group">
                            <select id="humanistic-cognition-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('human-needs-hierarchy-filter')">
                        <span>Human Needs Hierarchy</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="human-needs-hierarchy-filter-content">
                        <div class="filter-group">
                            <select id="human-needs-hierarchy-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('self-actualization-filter')">
                        <span>Self Actualization</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="self-actualization-filter-content">
                        <div class="filter-group">
                            <select id="self-actualization-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('behavioral-growth-filter')">
                        <span>Behavioral Growth</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="behavioral-growth-filter-content">
                        <div class="filter-group">
                            <select id="behavioral-growth-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <!-- Tier 1 Expansion: Technology Relationship -->
                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('technology-filter')">
                        <span>Technology Relationship</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="technology-filter-content">
                        <div class="filter-group">
                            <select id="technology-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <!-- Tier 1 Expansion: Crisis Response -->
                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('crisis-response-filter')">
                        <span>Crisis Response</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="crisis-response-filter-content">
                        <div class="filter-group">
                            <select id="crisis-response-filter" multiple></select>
                        </div>
                    </div>
                </div>

                <!-- Tier 1 Expansion: Influence Style -->
                <div class="filter-item">
                    <div class="filter-header" onclick="toggleFilter('influence-style-filter')">
                        <span>Influence Style</span>
                        <span class="filter-icon">+</span>
                    </div>
                    <div class="filter-content" id="influence-style-filter-content">
                        <div class="filter-group">
                            <select id="influence-style-filter" multiple></select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Colophon Button - Bottom of left column, outside filters frame -->
            <div class="filters" style="margin-top: 16px;">
                <div class="filter-item" style="padding: 8px;">
                    <button id="colophon-btn" class="super-filter-btn" style="width: 100%; padding: 12px; font-size: 14px; text-align: center;">
                        ℹ About This Project
                    </button>
                </div>
            </div>
            </div>
            
            <div class="profiles-section">
                <div id="profiles-container" class="profiles-grid">
                    <div class="loading">Loading profiles... <span id="loading-progress">0%</span></div>
                </div>
            </div>
        </div>
        
        <div id="expanded-profile" class="expanded-profile">
            <div class="expanded-profile-header">
                <div>
                    <div class="expanded-profile-title" id="expanded-name"></div>
                    <div class="expanded-profile-subtitle" id="expanded-subtitle"></div>
                </div>
                <div class="expanded-profile-actions">
                    <button class="btn btn-secondary" id="expanded-copy-btn" onclick="copyExpandedProfile()">Copy</button>
                    <button class="btn btn-primary" id="expanded-download-btn" onclick="downloadExpandedProfile()">Download</button>
                    <div class="close-expanded" onclick="closeExpandedProfile()">×</div>
                </div>
            </div>
            <div class="expanded-profile-content" id="expanded-content">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>

        <!-- Colophon Modal -->
        <div id="colophon-modal" class="expanded-profile">
            <div class="expanded-profile-header">
                <div>
                    <div class="expanded-profile-title">Colophon</div>
                    <div class="expanded-profile-subtitle">About This Project</div>
                </div>
                <div class="expanded-profile-actions">
                    <div class="close-expanded" onclick="closeColophon()">×</div>
                </div>
            </div>
            <div class="expanded-profile-content colophon-content" id="colophon-content">
                <!-- Colophon content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <div id="comparison-panel" class="comparison-panel">
        <div class="comparison-header">
            <h3>Profile Comparison (<span id="comparison-count">0</span> selected)</h3>
            <div>
                <button id="compare-btn" class="btn btn-primary" disabled>Compare Profiles</button>
                <button id="clear-comparison-btn" class="btn btn-secondary">Clear Selection</button>
                <button id="close-comparison-btn" class="btn btn-secondary">Close</button>
            </div>
        </div>
        <div id="comparison-content"></div>
    </div>

    <script>
        let allProfiles = [];
        let filteredProfiles = [];
        let currentView = 'grid';
        
        // 🚀 PERFORMANCE: Filter memoization cache
        const filterCache = new Map();
        let lastFilterState = null;


        // Function to generate filename from name
        function generateFilename(name) {
            const parts = name.split(' ');
            if (parts.length >= 2) {
                const lastName = parts[parts.length - 1];
                const firstName = parts.slice(0, -1).join(' ');
                // Keep accented characters and only remove truly problematic characters
                const formattedName = `${lastName}-${firstName}`;
                return formattedName.toLowerCase()
                    .replace(/[^\w\s\-àáâãäåæçèéêëìíîïðñòóôõöøùúûüýþÿ]/g, '')
                    .replace(/[\s]+/g, '-') + '.json';
            }
            return name.toLowerCase()
                .replace(/[^\w\s\-àáâãäåæçèéêëìíîïðñòóôõöøùúûüýþÿ]/g, '')
                .replace(/[\s]+/g, '-') + '.json';
        }

        console.log('🔄 Script loaded and executing...');

        // Helper function to get last name for sorting
        function getLastName(fullName) {
            const parts = fullName.trim().split(' ');
            return parts[parts.length - 1] || fullName;
        }

        async function loadProfiles() {
            try {
                console.log('🔄 Loading profiles from all-profiles.json...');
                
                const response = await fetch('all-profiles.json?v=7.1');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                allProfiles = data;
                console.log(`✅ Loaded ${allProfiles.length} profiles from server`);
                
                // Sort profiles alphabetically by last name
                allProfiles.sort((a, b) => getLastName(a.name).localeCompare(getLastName(b.name)));
                console.log(`📊 Profiles sorted alphabetically: ${allProfiles.length} total`);
                
                // 🚀 PERFORMANCE OPTIMIZATION: Consolidated parsing in single loop
                console.time('⚡ Profile parsing');
                allProfiles.forEach(profile => {
                    // Helper function to parse comma-separated or array fields
                    const parseField = (value, skipPlaceholder = null) => {
                        if (!value) return [];
                        if (skipPlaceholder && value === skipPlaceholder) return [];
                        
                        const terms = Array.isArray(value) 
                            ? value.map(term => term.trim())
                            : value.split(',').map(term => term.trim());
                        
                        const filtered = terms.filter(term => term.length > 0);
                        return [...new Set(filtered)].sort();
                    };
                    
                    // Initialize nested objects if they don't exist
                    profile.communication_style = profile.communication_style || {};
                    profile.behavioral_patterns = profile.behavioral_patterns || {};
                    profile.collaboration = profile.collaboration || {};
                    profile.values = profile.values || {};
                    profile.temporal_context = profile.temporal_context || {};
                    profile.cultural_context = profile.cultural_context || {};
                    profile.practical_application = profile.practical_application || {};
                    profile.learning = profile.learning || {};
                    profile.communication = profile.communication || {};
                    profile.psychological_profile = profile.psychological_profile || {};
                    profile.domain_expertise = profile.domain_expertise || {};
                    
                    // Parse all fields in one pass
                    profile.communication_style.tone_parsed = parseField(profile.communication_style.tone);
                    profile.communication_style.sentence_structure_parsed = parseField(profile.communication_style.sentence_structure);
                    profile.behavioral_patterns.work_style_parsed = parseField(profile.behavioral_patterns.work_style);
                    profile.behavioral_patterns.problem_solving_approach_parsed = parseField(profile.behavioral_patterns.problem_solving_approach);
                    profile.values.core_values_parsed = parseField(profile.values.core_values, 'fundamental principles that guide decisions');
                    profile.temporal_context.career_evolution_parsed = parseField(profile.temporal_context.career_evolution, 'career evolution over time');
                    profile.temporal_context.influence_timeline_parsed = parseField(profile.temporal_context.influence_timeline);
                    profile.temporal_context.legacy_impact_parsed = parseField(profile.temporal_context.legacy_impact);
                    profile.cultural_context.cultural_background_parsed = parseField(profile.cultural_context.cultural_background, 'how background shapes their perspective');
                    profile.practical_application.decision_speed_parsed = parseField(profile.practical_application.decision_speed, 'how quickly they make decisions');
                    profile.learning.learning_style_parsed = parseField(profile.learning.learning_style, 'how they acquire new knowledge');
                    profile.communication.audience_adaptation_parsed = parseField(profile.communication.audience_adaptation);
                    profile.psychological_profile.primary_traits_parsed = parseField(profile.psychological_profile.primary_traits);
                    profile.domain_expertise.core_competencies_parsed = parseField(profile.domain_expertise.core_competencies);
                    
                    // Parse collaboration fields (multiple sub-fields)
                    if (profile.collaboration) {
                        const collaborationFields = ['leadership_style', 'team_dynamics', 'mentorship_approach', 'conflict_resolution'];
                        collaborationFields.forEach(field => {
                            profile.collaboration[field + '_parsed'] = parseField(profile.collaboration[field]);
                        });
                    }
                });
                console.timeEnd('⚡ Profile parsing');
                
                /*
                // Parse communication style tones for each profile
                allProfiles.forEach(profile => {
                    if (profile.communication_style?.tone) {
                        // Handle both array and string formats
                        const toneTerms = Array.isArray(profile.communication_style.tone) 
                            ? profile.communication_style.tone.map(term => term.trim())
                            : profile.communication_style.tone.split(',').map(term => term.trim());
                        
                        // Filter out empty terms
                        const filteredTerms = toneTerms.filter(term => term.length > 0);
                        
                        // Remove duplicates and sort alphabetically
                        const uniqueTerms = [...new Set(filteredTerms)].sort();
                        profile.communication_style.tone_parsed = uniqueTerms;
                    } else {
                        profile.communication_style = profile.communication_style || {};
                        profile.communication_style.tone_parsed = [];
                    }
                });
                
                // Parse work styles for each profile
                allProfiles.forEach(profile => {
                    if (profile.behavioral_patterns?.work_style) {
                        // Handle both array and string formats
                        const workStyleTerms = Array.isArray(profile.behavioral_patterns.work_style) 
                            ? profile.behavioral_patterns.work_style.map(term => term.trim())
                            : profile.behavioral_patterns.work_style.split(',').map(term => term.trim());
                        
                        // Filter out empty terms and remove duplicates
                        const filteredTerms = workStyleTerms.filter(term => term.length > 0);
                        const uniqueTerms = [...new Set(filteredTerms)].sort();
                        profile.behavioral_patterns.work_style_parsed = uniqueTerms;
                    } else {
                        profile.behavioral_patterns = profile.behavioral_patterns || {};
                        profile.behavioral_patterns.work_style_parsed = [];
                    }
                });
                
                // Parse collaboration fields for each profile
                allProfiles.forEach(profile => {
                    if (profile.collaboration) {
                        const collaborationFields = ['leadership_style', 'team_dynamics', 'mentorship_approach', 'conflict_resolution'];
                        
                        collaborationFields.forEach(field => {
                            if (profile.collaboration[field]) {
                                // Handle both array and string formats
                                const terms = Array.isArray(profile.collaboration[field]) 
                                    ? profile.collaboration[field].map(term => term.trim())
                                    : profile.collaboration[field].split(',').map(term => term.trim());
                                
                                // Filter out empty terms and remove duplicates
                                const filteredTerms = terms.filter(term => term.length > 0);
                                const uniqueTerms = [...new Set(filteredTerms)].sort();
                                profile.collaboration[field + '_parsed'] = uniqueTerms;
                            } else {
                                profile.collaboration[field + '_parsed'] = [];
                            }
                        });
                    } else {
                        profile.collaboration = {};
                        const collaborationFields = ['leadership_style', 'team_dynamics', 'mentorship_approach', 'conflict_resolution'];
                        collaborationFields.forEach(field => {
                            profile.collaboration[field + '_parsed'] = [];
                        });
                    }
                });
                
                // Parse sentence structure for each profile
                allProfiles.forEach(profile => {
                    if (profile.communication_style?.sentence_structure) {
                        // Split by comma, trim whitespace, remove duplicates, and alphabetize
                        const sentenceStructureTerms = profile.communication_style.sentence_structure
                            .split(',')
                            .map(term => term.trim())
                            .filter(term => term.length > 0);
                        
                        // Remove duplicates and sort alphabetically
                        const uniqueTerms = [...new Set(sentenceStructureTerms)].sort();
                        profile.communication_style.sentence_structure_parsed = uniqueTerms;
                    } else {
                        profile.communication_style = profile.communication_style || {};
                        profile.communication_style.sentence_structure_parsed = [];
                    }
                });
                
                // Parse core values for each profile
                allProfiles.forEach(profile => {
                    if (profile.values?.core_values) {
                        // Skip generic placeholder values
                        if (profile.values.core_values !== 'fundamental principles that guide decisions') {
                            // Handle both string and array formats
                            let coreValuesTerms;
                            if (Array.isArray(profile.values.core_values)) {
                                coreValuesTerms = profile.values.core_values;
                            } else {
                                // Split by comma, trim whitespace, remove duplicates, and alphabetize
                                coreValuesTerms = profile.values.core_values
                                    .split(',')
                                    .map(term => term.trim())
                                    .filter(term => term.length > 0);
                            }
                            
                            // Remove duplicates and sort alphabetically
                            const uniqueTerms = [...new Set(coreValuesTerms)].sort();
                            profile.values.core_values_parsed = uniqueTerms;
                        } else {
                            profile.values.core_values_parsed = [];
                        }
                    } else {
                        profile.values = profile.values || {};
                        profile.values.core_values_parsed = [];
                    }
                });
                
                // Parse problem solving approach for each profile
                allProfiles.forEach(profile => {
                    if (profile.behavioral_patterns?.problem_solving_approach) {
                        // Handle both array and string formats
                        const problemSolvingTerms = Array.isArray(profile.behavioral_patterns.problem_solving_approach) 
                            ? profile.behavioral_patterns.problem_solving_approach.map(term => term.trim())
                            : profile.behavioral_patterns.problem_solving_approach.split(',').map(term => term.trim());
                        
                        // Filter out empty terms and remove duplicates
                        const filteredTerms = problemSolvingTerms.filter(term => term.length > 0);
                        const uniqueTerms = [...new Set(filteredTerms)].sort();
                        profile.behavioral_patterns.problem_solving_approach_parsed = uniqueTerms;
                    } else {
                        profile.behavioral_patterns = profile.behavioral_patterns || {};
                        profile.behavioral_patterns.problem_solving_approach_parsed = [];
                    }
                });
                
                // Parse temporal context career evolution for each profile
                allProfiles.forEach(profile => {
                    if (profile.temporal_context?.career_evolution) {
                        // Skip generic placeholder values
                        if (profile.temporal_context.career_evolution !== 'career evolution over time') {
                            // Handle both array and string formats
                            const careerEvolutionTerms = Array.isArray(profile.temporal_context.career_evolution) 
                                ? profile.temporal_context.career_evolution.map(term => term.trim())
                                : profile.temporal_context.career_evolution.split(',').map(term => term.trim());
                            
                            // Filter out empty terms and remove duplicates
                            const filteredTerms = careerEvolutionTerms.filter(term => term.length > 0);
                            const uniqueTerms = [...new Set(filteredTerms)].sort();
                            profile.temporal_context.career_evolution_parsed = uniqueTerms;
                        } else {
                            profile.temporal_context.career_evolution_parsed = [];
                        }
                    } else {
                        profile.temporal_context = profile.temporal_context || {};
                        profile.temporal_context.career_evolution_parsed = [];
                    }
                });
                
                // Parse cultural context cultural background for each profile
                allProfiles.forEach(profile => {
                    if (profile.cultural_context?.cultural_background) {
                        // Skip generic placeholder values
                        if (profile.cultural_context.cultural_background !== 'how background shapes their perspective') {
                            // Handle both array and string formats
                            const culturalBackgroundTerms = Array.isArray(profile.cultural_context.cultural_background) 
                                ? profile.cultural_context.cultural_background.map(term => term.trim())
                                : profile.cultural_context.cultural_background.split(',').map(term => term.trim());
                            
                            // Filter out empty terms and remove duplicates
                            const filteredTerms = culturalBackgroundTerms.filter(term => term.length > 0);
                            const uniqueTerms = [...new Set(filteredTerms)].sort();
                            profile.cultural_context.cultural_background_parsed = uniqueTerms;
                        } else {
                            profile.cultural_context.cultural_background_parsed = [];
                        }
                    } else {
                        profile.cultural_context = profile.cultural_context || {};
                        profile.cultural_context.cultural_background_parsed = [];
                    }
                });
                
                // Parse practical application decision speed for each profile
                allProfiles.forEach(profile => {
                    if (profile.practical_application?.decision_speed) {
                        // Skip generic placeholder values
                        if (profile.practical_application.decision_speed !== 'how quickly they make decisions') {
                            // Handle both array and string formats
                            const decisionSpeedTerms = Array.isArray(profile.practical_application.decision_speed) 
                                ? profile.practical_application.decision_speed.map(term => term.trim())
                                : profile.practical_application.decision_speed.split(',').map(term => term.trim());
                            
                            // Filter out empty terms and remove duplicates
                            const filteredTerms = decisionSpeedTerms.filter(term => term.length > 0);
                            const uniqueTerms = [...new Set(filteredTerms)].sort();
                            profile.practical_application.decision_speed_parsed = uniqueTerms;
                        } else {
                            profile.practical_application.decision_speed_parsed = [];
                        }
                    } else {
                        profile.practical_application = profile.practical_application || {};
                        profile.practical_application.decision_speed_parsed = [];
                    }
                });
                
                // Parse learning learning style for each profile
                allProfiles.forEach(profile => {
                    if (profile.learning?.learning_style) {
                        // Skip generic placeholder values
                        if (profile.learning.learning_style !== 'how they acquire new knowledge') {
                            // Handle both array and string formats
                            const learningStyleTerms = Array.isArray(profile.learning.learning_style) 
                                ? profile.learning.learning_style.map(term => term.trim())
                                : profile.learning.learning_style.split(',').map(term => term.trim());
                            
                            // Filter out empty terms and remove duplicates
                            const filteredTerms = learningStyleTerms.filter(term => term.length > 0);
                            const uniqueTerms = [...new Set(filteredTerms)].sort();
                            profile.learning.learning_style_parsed = uniqueTerms;
                        } else {
                            profile.learning.learning_style_parsed = [];
                        }
                    } else {
                        profile.learning = profile.learning || {};
                        profile.learning.learning_style_parsed = [];
                    }
                });
                
                // Parse communication audience adaptation for each profile
                allProfiles.forEach(profile => {
                    if (profile.communication?.audience_adaptation) {
                        // Handle both array and string formats
                        if (Array.isArray(profile.communication.audience_adaptation) || profile.communication.audience_adaptation.includes(',')) {
                            const audienceAdaptationTerms = Array.isArray(profile.communication.audience_adaptation) 
                                ? profile.communication.audience_adaptation.map(term => term.trim())
                                : profile.communication.audience_adaptation.split(',').map(term => term.trim());
                            
                            // Filter out empty terms and remove duplicates
                            const filteredTerms = audienceAdaptationTerms.filter(term => term.length > 0);
                            const uniqueTerms = [...new Set(filteredTerms)].sort();
                            profile.communication.audience_adaptation_parsed = uniqueTerms;
                        } else {
                            profile.communication.audience_adaptation_parsed = [];
                        }
                    } else {
                        profile.communication = profile.communication || {};
                        profile.communication.audience_adaptation_parsed = [];
                    }
                });
                
                // Parse temporal context influence timeline for each profile
                allProfiles.forEach(profile => {
                    if (profile.temporal_context?.influence_timeline) {
                        // Handle both array and string formats
                        if (Array.isArray(profile.temporal_context.influence_timeline) || profile.temporal_context.influence_timeline.includes(',')) {
                            const influenceTimelineTerms = Array.isArray(profile.temporal_context.influence_timeline) 
                                ? profile.temporal_context.influence_timeline.map(term => term.trim())
                                : profile.temporal_context.influence_timeline.split(',').map(term => term.trim());
                            
                            // Filter out empty terms and remove duplicates
                            const filteredTerms = influenceTimelineTerms.filter(term => term.length > 0);
                            const uniqueTerms = [...new Set(filteredTerms)].sort();
                            profile.temporal_context.influence_timeline_parsed = uniqueTerms;
                        } else {
                            profile.temporal_context.influence_timeline_parsed = [];
                        }
                    } else {
                        profile.temporal_context = profile.temporal_context || {};
                        profile.temporal_context.influence_timeline_parsed = [];
                    }
                });
                
                // Parse temporal context legacy impact for each profile
                allProfiles.forEach(profile => {
                    if (profile.temporal_context?.legacy_impact) {
                        // Handle both array and string formats
                        if (Array.isArray(profile.temporal_context.legacy_impact) || profile.temporal_context.legacy_impact.includes(',')) {
                            const legacyImpactTerms = Array.isArray(profile.temporal_context.legacy_impact) 
                                ? profile.temporal_context.legacy_impact.map(term => term.trim())
                                : profile.temporal_context.legacy_impact.split(',').map(term => term.trim());
                            
                            // Filter out empty terms and remove duplicates
                            const filteredTerms = legacyImpactTerms.filter(term => term.length > 0);
                            const uniqueTerms = [...new Set(filteredTerms)].sort();
                            profile.temporal_context.legacy_impact_parsed = uniqueTerms;
                        } else {
                            profile.temporal_context.legacy_impact_parsed = [];
                        }
                    } else {
                        profile.temporal_context = profile.temporal_context || {};
                        profile.temporal_context.legacy_impact_parsed = [];
                    }
                });
                
                // Parse communication.audience_adaptation for each profile
                allProfiles.forEach(profile => {
                    if (profile.communication?.audience_adaptation) {
                        // Handle both array and string formats
                        const audienceAdaptationTerms = Array.isArray(profile.communication.audience_adaptation)
                            ? profile.communication.audience_adaptation.map(term => term.trim())
                            : profile.communication.audience_adaptation.split(',').map(term => term.trim());

                        const filteredTerms = audienceAdaptationTerms.filter(term => term.length > 0);
                        const uniqueTerms = [...new Set(filteredTerms)].sort();
                        profile.communication.audience_adaptation_parsed = uniqueTerms;
                    } else {
                        profile.communication = profile.communication || {};
                        profile.communication.audience_adaptation_parsed = [];
                    }
                });
                
                // Parse psychological_profile.primary_traits for each profile
                allProfiles.forEach(profile => {
                    if (profile.psychological_profile?.primary_traits) {
                        // Handle both array and string formats
                        const primaryTraitsTerms = Array.isArray(profile.psychological_profile.primary_traits)
                            ? profile.psychological_profile.primary_traits.map(term => term.trim())
                            : profile.psychological_profile.primary_traits.split(',').map(term => term.trim());

                        const filteredTerms = primaryTraitsTerms.filter(term => term.length > 0);
                        const uniqueTerms = [...new Set(filteredTerms)].sort();
                        profile.psychological_profile.primary_traits_parsed = uniqueTerms;
                    } else {
                        profile.psychological_profile = profile.psychological_profile || {};
                        profile.psychological_profile.primary_traits_parsed = [];
                    }
                });
                
                // Parse domain_expertise.core_competencies for each profile
                allProfiles.forEach(profile => {
                    if (profile.domain_expertise?.core_competencies) {
                        // Handle both array and string formats
                        const coreCompetenciesTerms = Array.isArray(profile.domain_expertise.core_competencies)
                            ? profile.domain_expertise.core_competencies.map(term => term.trim())
                            : profile.domain_expertise.core_competencies.split(',').map(term => term.trim());

                        const filteredTerms = coreCompetenciesTerms.filter(term => term.length > 0);
                        const uniqueTerms = [...new Set(filteredTerms)].sort();
                        profile.domain_expertise.core_competencies_parsed = uniqueTerms;
                    } else {
                        profile.domain_expertise = profile.domain_expertise || {};
                        profile.domain_expertise.core_competencies_parsed = [];
                    }
                });
                */
                
                console.log(`✓ Loaded ${allProfiles.length} profiles from JSON file (sorted alphabetically)`);
                
                initializeFilters();
                initializeQuickNavigation();
                filteredProfiles = allProfiles.slice();
                console.log('🔄 Initial state - allProfiles:', allProfiles.length, 'filteredProfiles:', filteredProfiles.length);
                console.log('🔄 About to display profiles...');
                displayProfiles();
                
                console.log('🚀 Profiles loaded and displayed successfully!');
                
            } catch (error) {
                console.error('Error loading profiles:', error);
                document.getElementById('profiles-container').innerHTML = 
                    '<div class="no-results">Error loading profiles. Please check the console for details.</div>';
            }
        }

        function initializeFilters() {
            console.log('🔄 initializeFilters called with', allProfiles.length, 'profiles');
            
            const filters = {
                'archetype-filter': 'archetype',
                'domain-filter': 'domain',
                'subdomain-filter': 'sub_domain',
                'trait-filter': 'psychological_profile.primary_traits',
                'communication-filter': 'communication_style.tone',
                'sentence-structure-filter': 'communication_style.sentence_structure',
                'expertise-filter': 'domain_expertise.core_competencies',
                'background-filter': 'background_context.experience_level',
                'behavior-filter': 'behavioral_patterns.work_style',
                'problem-solving-filter': 'behavioral_patterns.problem_solving_approach',
                'identifier-filter': 'unique_identifiers.signature_methodologies',
                'temporal-filter': 'temporal_context.career_evolution',
                'collaboration-filter': 'collaboration.leadership_style',
                'cultural-filter': 'cultural_context.cultural_background',
                'practical-filter': 'practical_application.decision_speed',
                'communication-new-filter': 'communication.audience_adaptation',
                'learning-filter': 'learning.learning_style',
                'values-filter': 'values.core_values',
                'bias-awareness-filter': 'bias_awareness.primary_biases',
                'growth-motivation-filter': 'growth_motivation.intrinsic_drivers',
                'cognitive-humanism-filter': 'cognitive_humanism.empathy_expression',
                'humanistic-cognition-filter': 'humanistic_cognition.creative_problem_solving',
                'human-needs-hierarchy-filter': 'human_needs_hierarchy.need_priorities',
                'self-actualization-filter': 'self_actualization_indicators.peak_experiences',
                'behavioral-growth-filter': 'behavioral_growth.adaptation_patterns',
                'technology-filter': 'technology_relationship.technology_adoption',
                'crisis-response-filter': 'crisis_response.stress_response_pattern',
                'influence-style-filter': 'influence_style.persuasion_approach'
            };

            console.log('🔍 Checking each filter element...');
            Object.entries(filters).forEach(([filterId, dataPath]) => {
                const filter = document.getElementById(filterId);
                if (!filter) {
                    console.log('⚠️ Filter not found:', filterId);
                    return;
                }
                const values = new Set();

                allProfiles.forEach(profile => {
                    const value = getNestedValue(profile, dataPath);
                    if (Array.isArray(value)) {
                        value.forEach(v => values.add(v));
                    } else if (value && typeof value === 'string') {
                        // Handle comma-separated strings
                        const valueArray = value.split(',').map(v => v.trim());
                        valueArray.forEach(v => values.add(v));
                    } else if (value) {
                        values.add(value);
                    }
                });

                console.log(`✓ Populating ${filterId} with ${values.size} values:`, Array.from(values));

                // Clear existing options
                filter.innerHTML = '';

                values.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    
                    option.textContent = value;
                    
                    // Add click handler for deselection
                    option.addEventListener('mousedown', function(e) {
                        if (this.selected) {
                            e.preventDefault();
                            this.selected = false;
                            filterProfiles();
                        }
                    });
                    
                    filter.appendChild(option);
                });

                // Don't add event listeners during initialization to avoid premature filtering
                // filter.addEventListener('change', filterProfiles);
            });

            // Add event listeners after initialization is complete
            setTimeout(() => {
                Object.keys(filters).forEach(filterId => {
                    const filter = document.getElementById(filterId);
                    if (filter) {
                        filter.addEventListener('change', function() {
                            updateCascadingFilters();
                            filterProfiles();
                        });
                    }
                });
                const searchFilter = document.getElementById('search-filter');
                if (searchFilter) {
                    searchFilter.addEventListener('input', debouncedFilterProfiles);
                }
                console.log('✓ Event listeners added to all filters with cascading support');
            }, 100);
        }

        function getCurrentlyFilteredProfiles() {
            const filters = {
                'archetype-filter': 'archetype',
                'domain-filter': 'domain',
                'subdomain-filter': 'sub_domain',
                'trait-filter': 'psychological_profile.primary_traits',
                'communication-filter': 'communication_style.tone',
                'sentence-structure-filter': 'communication_style.sentence_structure',
                'expertise-filter': 'domain_expertise.core_competencies',
                'background-filter': 'background_context.experience_level',
                'behavior-filter': 'behavioral_patterns.work_style',
                'problem-solving-filter': 'behavioral_patterns.problem_solving_approach',
                'identifier-filter': 'unique_identifiers.signature_methodologies',
                'temporal-filter': 'temporal_context.career_evolution',
                'collaboration-filter': 'collaboration.leadership_style',
                'cultural-filter': 'cultural_context.cultural_background',
                'practical-filter': 'practical_application.decision_speed',
                'communication-new-filter': 'communication.audience_adaptation',
                'learning-filter': 'learning.learning_style',
                'values-filter': 'values.core_values',
                'bias-awareness-filter': 'bias_awareness.primary_biases',
                'growth-motivation-filter': 'growth_motivation.intrinsic_drivers',
                'cognitive-humanism-filter': 'cognitive_humanism.empathy_expression',
                'humanistic-cognition-filter': 'humanistic_cognition.creative_problem_solving',
                'human-needs-hierarchy-filter': 'human_needs_hierarchy.need_priorities',
                'self-actualization-filter': 'self_actualization_indicators.peak_experiences',
                'behavioral-growth-filter': 'behavioral_growth.adaptation_patterns',
                'technology-filter': 'technology_relationship.technology_adoption',
                'crisis-response-filter': 'crisis_response.stress_response_pattern',
                'influence-style-filter': 'influence_style.persuasion_approach'
            };

            let filtered = allProfiles;

            // Apply each filter
            Object.entries(filters).forEach(([filterId, dataPath]) => {
                const filter = document.getElementById(filterId);
                if (!filter) return;

                const selectedValues = Array.from(filter.selectedOptions).map(option => option.value);
                if (selectedValues.length === 0) return;

                filtered = filtered.filter(profile => {
                    const value = getNestedValue(profile, dataPath);
                    
                    if (Array.isArray(value)) {
                        return selectedValues.some(selected => value.includes(selected));
                    } else if (value && typeof value === 'string') {
                        // Handle comma-separated strings
                        const valueArray = value.split(',').map(v => v.trim());
                        return selectedValues.some(selected => valueArray.includes(selected));
                    } else if (value) {
                        return selectedValues.includes(value);
                    }
                    return false;
                });
            });

            return filtered;
        }

        function updateCascadingFilters() {
            console.log('🔄 Updating cascading filters...');
            
            const filters = {
                'archetype-filter': 'archetype',
                'domain-filter': 'domain',
                'subdomain-filter': 'sub_domain',
                'trait-filter': 'psychological_profile.primary_traits',
                'communication-filter': 'communication_style.tone',
                'sentence-structure-filter': 'communication_style.sentence_structure',
                'expertise-filter': 'domain_expertise.core_competencies',
                'background-filter': 'background_context.experience_level',
                'behavior-filter': 'behavioral_patterns.work_style',
                'problem-solving-filter': 'behavioral_patterns.problem_solving_approach',
                'identifier-filter': 'unique_identifiers.signature_methodologies',
                'temporal-filter': 'temporal_context.career_evolution',
                'collaboration-filter': 'collaboration.leadership_style',
                'cultural-filter': 'cultural_context.cultural_background',
                'practical-filter': 'practical_application.decision_speed',
                'communication-new-filter': 'communication.audience_adaptation',
                'learning-filter': 'learning.learning_style',
                'values-filter': 'values.core_values',
                'bias-awareness-filter': 'bias_awareness.primary_biases',
                'growth-motivation-filter': 'growth_motivation.intrinsic_drivers',
                'cognitive-humanism-filter': 'cognitive_humanism.empathy_expression',
                'humanistic-cognition-filter': 'humanistic_cognition.creative_problem_solving',
                'human-needs-hierarchy-filter': 'human_needs_hierarchy.need_priorities',
                'self-actualization-filter': 'self_actualization_indicators.peak_experiences',
                'behavioral-growth-filter': 'behavioral_growth.adaptation_patterns',
                'technology-filter': 'technology_relationship.technology_adoption',
                'crisis-response-filter': 'crisis_response.stress_response_pattern',
                'influence-style-filter': 'influence_style.persuasion_approach'
            };
            
            // Get currently filtered profiles based on all current selections
            const currentlyFilteredProfiles = getCurrentlyFilteredProfiles();
            console.log(`📊 Cascading filters based on ${currentlyFilteredProfiles.length} currently matching profiles`);

            // Update each filter's available options
            Object.entries(filters).forEach(([filterId, dataPath]) => {
                const filter = document.getElementById(filterId);
                if (!filter) return;

                // Get current selections for this filter
                const currentSelections = Array.from(filter.selectedOptions).map(option => option.value);
                
                // Get available values from currently filtered profiles
                const availableValues = new Set();
                currentlyFilteredProfiles.forEach(profile => {
                    const value = getNestedValue(profile, dataPath);
                    if (Array.isArray(value)) {
                        value.forEach(v => availableValues.add(v));
                    } else if (value && typeof value === 'string') {
                        // Handle comma-separated strings
                        const valueArray = value.split(',').map(v => v.trim());
                        valueArray.forEach(v => availableValues.add(v));
                    } else if (value) {
                        availableValues.add(value);
                    }
                });

                // Store which options were selected before updating
                const selectedValues = new Set(currentSelections);

                // Update options
                filter.innerHTML = '';
                
                // Custom sort for background context (experience levels)
                let sortedValues;
                if (filterId === 'background-filter') {
                    const experienceOrder = ['Entry-level', 'Junior', 'Mid-level', 'Senior', 'Executive', 'C-level', 'Founder'];
                    sortedValues = Array.from(availableValues).sort((a, b) => {
                        const aIndex = experienceOrder.indexOf(a);
                        const bIndex = experienceOrder.indexOf(b);
                        if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                        if (aIndex !== -1) return -1;
                        if (bIndex !== -1) return 1;
                        return a.toLowerCase().localeCompare(b.toLowerCase());
                    });
                } else {
                    sortedValues = Array.from(availableValues).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
                }
                
                sortedValues.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    
                    option.textContent = value;
                    
                    // Restore selection if it was previously selected
                    if (selectedValues.has(value)) {
                        option.selected = true;
                    }
                    
                    // Add click handler for deselection
                    option.addEventListener('mousedown', function(e) {
                        if (this.selected) {
                            e.preventDefault();
                            this.selected = false;
                            updateCascadingFilters();
                            filterProfiles();
                        }
                    });
                    
                    filter.appendChild(option);
                });

                console.log(`✓ Updated ${filterId}: ${availableValues.size} available options, ${selectedValues.size} selected`);
            });
        }

        function clearAllFilters() {
            console.log('🧹 Clearing all filters...');
            
            const filters = {
                'archetype-filter': 'archetype',
                'domain-filter': 'domain',
                'subdomain-filter': 'sub_domain',
                'trait-filter': 'psychological_profile.primary_traits',
                'communication-filter': 'communication_style.tone',
                'sentence-structure-filter': 'communication_style.sentence_structure',
                'expertise-filter': 'domain_expertise.core_competencies',
                'background-filter': 'background_context.experience_level',
                'behavior-filter': 'behavioral_patterns.work_style',
                'problem-solving-filter': 'behavioral_patterns.problem_solving_approach',
                'identifier-filter': 'unique_identifiers.signature_methodologies',
                'temporal-filter': 'temporal_context.career_evolution',
                'collaboration-filter': 'collaboration.leadership_style',
                'cultural-filter': 'cultural_context.cultural_background',
                'practical-filter': 'practical_application.decision_speed',
                'communication-new-filter': 'communication.audience_adaptation',
                'learning-filter': 'learning.learning_style',
                'values-filter': 'values.core_values',
                'bias-awareness-filter': 'bias_awareness.primary_biases',
                'growth-motivation-filter': 'growth_motivation.intrinsic_drivers',
                'cognitive-humanism-filter': 'cognitive_humanism.empathy_expression',
                'humanistic-cognition-filter': 'humanistic_cognition.creative_problem_solving',
                'human-needs-hierarchy-filter': 'human_needs_hierarchy.need_priorities',
                'self-actualization-filter': 'self_actualization_indicators.peak_experiences',
                'behavioral-growth-filter': 'behavioral_growth.adaptation_patterns',
                'technology-filter': 'technology_relationship.technology_adoption',
                'crisis-response-filter': 'crisis_response.stress_response_pattern',
                'influence-style-filter': 'influence_style.persuasion_approach'
            };
            
            // Clear all filter selections
            Object.keys(filters).forEach(filterId => {
                const filter = document.getElementById(filterId);
                if (filter) {
                    filter.selectedIndex = -1; // Clear all selections
                }
            });
            
            // Clear search
            const searchFilter = document.getElementById('search-filter');
            if (searchFilter) {
                searchFilter.value = '';
            }
            
            // Update cascading filters and apply
            updateCascadingFilters();
            filterProfiles();
            
            console.log('✅ All filters cleared');
        }

        function applySuperFilter(category) {
            console.log(`🎯 Applying super filter: ${category}`);
            
            // Check if clicking the same category (deselection)
            if (activeSuperFilter === category) {
                console.log(`🔄 Deselecting super filter: ${category}`);
                clearAllFilters();
                activeSuperFilter = null;
                updateSuperFilterButtons();
                return;
            }
            
            // Clear all existing filters first
            clearAllFilters();
            
            // Filter profiles by category directly
            filteredProfiles = allProfiles.filter(profile => {
                return profile.category === category;
            });
            
            // Sort filtered results alphabetically by last name
            filteredProfiles.sort((a, b) => getLastName(a.name).localeCompare(getLastName(b.name)));
            
            // Update quick navigation stats
            updateQuickNavigationStats();
            
            // Display results
            displayProfiles();
            
            // Set active super filter
            activeSuperFilter = category;
            updateSuperFilterButtons();
            
            console.log(`✅ Applied ${category} super filter - found ${filteredProfiles.length} profiles`);
        }

        function updateSuperFilterButtons() {
            const buttons = document.querySelectorAll('.super-filter-btn');
            buttons.forEach(button => {
                const category = button.textContent.toLowerCase().replace(' ', '');
                if (category === 'clearall') return; // Skip Clear All button
                
                if (activeSuperFilter === category) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        function getNestedValue(obj, path) {
            return path.split('.').reduce((current, key) => current && current[key], obj);
        }

        function initializeQuickNavigation() {
            // Update navigation count display
            const totalCountNav = document.getElementById('total-count-nav');
            if (totalCountNav) totalCountNav.textContent = allProfiles.length;
            const visibleCountNav = document.getElementById('visible-count-nav');
            if (visibleCountNav) visibleCountNav.textContent = allProfiles.length;
            
            // Create alphabet navigation
            const alphabetNav = document.getElementById('alphabet-nav');
            if (!alphabetNav) return; // Skip if alphabet nav doesn't exist
            
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            
            // Get first letters of all profile last names
            const firstLetters = new Set();
            allProfiles.forEach(profile => {
                const lastLetter = getLastName(profile.name).charAt(0).toUpperCase();
                firstLetters.add(lastLetter);
            });
            
            alphabet.forEach((letter, index) => {
                const link = document.createElement('span');
                link.className = 'alphabet-link';
                link.textContent = letter;
                
                if (firstLetters.has(letter)) {
                    link.onclick = () => jumpToLetter(letter);
                } else {
                    link.className += ' disabled';
                }
                
                alphabetNav.appendChild(link);
                
                // Add separator after each letter except the last one
                if (index < alphabet.length - 1) {
                    const separator = document.createElement('span');
                    separator.className = 'alphabet-separator';
                    separator.textContent = '|';
                    alphabetNav.appendChild(separator);
                }
            });
        }

        function jumpToLetter(letter) {
            // Find first profile with last name starting with this letter
            const targetProfile = allProfiles.find(profile => 
                getLastName(profile.name).charAt(0).toUpperCase() === letter
            );
            
            if (targetProfile) {
                // Clear all filters to show all profiles
                clearAllFilters();
                
                // Scroll to the profile card
                setTimeout(() => {
                    const profileCards = document.querySelectorAll('.profile-card');
                    const targetCard = Array.from(profileCards).find(card => 
                        card.querySelector('.card-name').textContent === targetProfile.name
                    );
                    
                    if (targetCard) {
                        targetCard.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                        
                        // Highlight the card briefly
                        targetCard.style.border = '3px solid #667eea';
                        setTimeout(() => {
                            targetCard.style.border = '';
                        }, 2000);
                    }
                }, 100);
            }
        }

        function updateQuickNavigationStats() {
            const visibleCountNav = document.getElementById('visible-count-nav');
            if (visibleCountNav) visibleCountNav.textContent = filteredProfiles.length;
        }

        // Debounced search for better performance
        let searchTimeout;
        function debouncedFilterProfiles() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterProfiles, 150); // 150ms delay
        }

        // Badge search function - filter profiles by trait/badge value
        function searchByBadge(badgeValue, event) {
            if (event) {
                event.stopPropagation(); // Prevent card selection
            }
            
            console.log('🔍 Searching by badge:', badgeValue);
            
            // Check if this is the same badge as currently active
            const currentlyActiveBadge = window.currentActiveBadge;
            
            if (currentlyActiveBadge === badgeValue) {
                // Same badge clicked - deselect and show all profiles
                console.log('🔍 Deselecting badge:', badgeValue);
                window.currentActiveBadge = null;
                
                // Remove active class from all badges
                document.querySelectorAll('.clickable-badge').forEach(badge => {
                    badge.classList.remove('active');
                });
                
                // Clear any existing search
                document.getElementById('search-filter').value = '';
                
                // Clear all filter selections
                const allFilters = document.querySelectorAll('select[multiple]');
                allFilters.forEach(filter => {
                    Array.from(filter.options).forEach(option => option.selected = false);
                });
                
                // Show all profiles
                filteredProfiles = [...allProfiles];
                
                // Update quick navigation stats
                updateQuickNavigationStats();
                
                // Display results
                displayProfiles();
                return;
            }
            
            // New badge selected - store it and filter
            window.currentActiveBadge = badgeValue;
            
            // Remove active class from all badges and add to clicked one
            document.querySelectorAll('.clickable-badge').forEach(badge => {
                badge.classList.remove('active');
                if (badge.textContent.trim() === badgeValue) {
                    badge.classList.add('active');
                }
            });
            
            // Clear any existing search
            document.getElementById('search-filter').value = '';
            
            // Clear all filter selections
            const allFilters = document.querySelectorAll('select[multiple]');
            allFilters.forEach(filter => {
                Array.from(filter.options).forEach(option => option.selected = false);
            });
            
            // Filter profiles that contain this badge value
            filteredProfiles = allProfiles.filter(profile => {
                const traits = profile.primary_traits || profile.psychological_profile?.primary_traits;
                if (!traits) return false;
                
                const traitArray = Array.isArray(traits) ? traits : traits.split(',').map(t => t.trim());
                return traitArray.some(trait => trait.toLowerCase().includes(badgeValue.toLowerCase()));
            });
            
            // Sort filtered results alphabetically by last name
            filteredProfiles.sort((a, b) => getLastName(a.name).localeCompare(getLastName(b.name)));
            
            // Update quick navigation stats
            updateQuickNavigationStats();
            
            // Display results
            displayProfiles();
            
            console.log(`✅ Found ${filteredProfiles.length} profiles with badge: ${badgeValue}`);
        }

        function filterProfiles() {
            console.time('⚡ filterProfiles');
            const searchTerm = document.getElementById('search-filter').value.toLowerCase();
            const selectedArchetypes = Array.from(document.getElementById('archetype-filter').selectedOptions).map(option => option.value);
            const selectedDomains = Array.from(document.getElementById('domain-filter').selectedOptions).map(option => option.value);
            const selectedSubDomains = Array.from(document.getElementById('subdomain-filter').selectedOptions).map(option => option.value);
            const selectedTraits = Array.from(document.getElementById('trait-filter').selectedOptions).map(option => option.value);
            const selectedCommunication = Array.from(document.getElementById('communication-filter').selectedOptions).map(option => option.value);
            const selectedSentenceStructure = Array.from(document.getElementById('sentence-structure-filter').selectedOptions).map(option => option.value);
            const selectedExpertise = Array.from(document.getElementById('expertise-filter').selectedOptions).map(option => option.value);
            const selectedBackground = Array.from(document.getElementById('background-filter').selectedOptions).map(option => option.value);
            const selectedBehavior = Array.from(document.getElementById('behavior-filter').selectedOptions).map(option => option.value);
            const selectedProblemSolving = Array.from(document.getElementById('problem-solving-filter').selectedOptions).map(option => option.value);
            const selectedIdentifiers = Array.from(document.getElementById('identifier-filter').selectedOptions).map(option => option.value);
            
            // New category filters
            const selectedTemporal = Array.from(document.getElementById('temporal-filter').selectedOptions).map(option => option.value);
            const selectedCollaboration = Array.from(document.getElementById('collaboration-filter').selectedOptions).map(option => option.value);
            const selectedCultural = Array.from(document.getElementById('cultural-filter').selectedOptions).map(option => option.value);
            const selectedPractical = Array.from(document.getElementById('practical-filter').selectedOptions).map(option => option.value);
            const selectedCommunicationNew = Array.from(document.getElementById('communication-new-filter').selectedOptions).map(option => option.value);
            const selectedLearning = Array.from(document.getElementById('learning-filter').selectedOptions).map(option => option.value);
            const selectedValues = Array.from(document.getElementById('values-filter').selectedOptions).map(option => option.value);
            const selectedBiasAwareness = Array.from(document.getElementById('bias-awareness-filter').selectedOptions).map(option => option.value);
            const selectedGrowthMotivation = Array.from(document.getElementById('growth-motivation-filter').selectedOptions).map(option => option.value);
            const selectedCognitiveHumanism = Array.from(document.getElementById('cognitive-humanism-filter').selectedOptions).map(option => option.value);
            const selectedHumanisticCognition = Array.from(document.getElementById('humanistic-cognition-filter').selectedOptions).map(option => option.value);
            const selectedHumanNeedsHierarchy = Array.from(document.getElementById('human-needs-hierarchy-filter').selectedOptions).map(option => option.value);
            const selectedSelfActualization = Array.from(document.getElementById('self-actualization-filter').selectedOptions).map(option => option.value);
            const selectedBehavioralGrowth = Array.from(document.getElementById('behavioral-growth-filter').selectedOptions).map(option => option.value);
            
            // Tier 1 category filters
            const selectedTechnology = Array.from(document.getElementById('technology-filter').selectedOptions).map(option => option.value);
            const selectedCrisisResponse = Array.from(document.getElementById('crisis-response-filter').selectedOptions).map(option => option.value);
            const selectedInfluenceStyle = Array.from(document.getElementById('influence-style-filter').selectedOptions).map(option => option.value);

            // 🚀 PERFORMANCE: Create filter state signature for memoization
            const filterState = JSON.stringify({
                searchTerm,
                selectedArchetypes,
                selectedDomains,
                selectedSubDomains,
                selectedTraits,
                selectedCommunication,
                selectedSentenceStructure,
                selectedExpertise,
                selectedBackground,
                selectedBehavior,
                selectedProblemSolving,
                selectedIdentifiers,
                selectedTemporal,
                selectedCollaboration,
                selectedCultural,
                selectedPractical,
                selectedCommunicationNew,
                selectedLearning,
                selectedValues,
                selectedBiasAwareness,
                selectedGrowthMotivation,
                selectedCognitiveHumanism,
                selectedHumanisticCognition,
                selectedHumanNeedsHierarchy,
                selectedSelfActualization,
                selectedBehavioralGrowth,
                selectedTechnology,
                selectedCrisisResponse,
                selectedInfluenceStyle
            });
            
            // Check cache
            if (filterState === lastFilterState && filterCache.has(filterState)) {
                console.log('✨ Using cached filter results');
                filteredProfiles = filterCache.get(filterState);
                updateQuickNavigationStats();
                displayProfiles();
                console.timeEnd('⚡ filterProfiles');
                return;
            }
            
            console.log('🔍 Computing new filter results');

            // If no filters are selected at all, show all profiles
            const hasAnySelections = searchTerm || 
                selectedArchetypes.length > 0 ||
                selectedDomains.length > 0 ||
                selectedSubDomains.length > 0 ||
                selectedTraits.length > 0 ||
                selectedCommunication.length > 0 ||
                selectedSentenceStructure.length > 0 ||
                selectedExpertise.length > 0 ||
                selectedBackground.length > 0 ||
                selectedBehavior.length > 0 ||
                selectedProblemSolving.length > 0 ||
                selectedIdentifiers.length > 0 ||
                selectedTemporal.length > 0 ||
                selectedCollaboration.length > 0 ||
                selectedCultural.length > 0 ||
                selectedPractical.length > 0 ||
                selectedCommunicationNew.length > 0 ||
                selectedLearning.length > 0 ||
                selectedValues.length > 0 ||
                selectedBiasAwareness.length > 0 ||
                selectedGrowthMotivation.length > 0 ||
                selectedCognitiveHumanism.length > 0 ||
                selectedHumanisticCognition.length > 0 ||
                selectedHumanNeedsHierarchy.length > 0 ||
                selectedSelfActualization.length > 0 ||
                selectedBehavioralGrowth.length > 0 ||
                selectedTechnology.length > 0 ||
                selectedCrisisResponse.length > 0 ||
                selectedInfluenceStyle.length > 0;

            if (!hasAnySelections) {
                console.log('✓ No filters selected - showing all profiles');
                filteredProfiles = allProfiles.slice();
                // Keep alphabetical order when no filters (by last name)
                filteredProfiles.sort((a, b) => getLastName(a.name).localeCompare(getLastName(b.name)));
                
                // Update quick navigation stats
                updateQuickNavigationStats();
                
                displayProfiles();
                return;
            }

            filteredProfiles = allProfiles.filter(profile => {
                // Enhanced text search across all fields
                const matchesSearch = !searchTerm || 
                    profile.name.toLowerCase().includes(searchTerm) ||
                    profile.archetype.toLowerCase().includes(searchTerm) ||
                    profile.domain.toLowerCase().includes(searchTerm) ||
                    (profile.sub_domain && profile.sub_domain.toLowerCase().includes(searchTerm)) ||
                    (profile.psychological_profile?.cognitive_style && profile.psychological_profile.cognitive_style.toLowerCase().includes(searchTerm)) ||
                    (profile.psychological_profile?.decision_making_framework && profile.psychological_profile.decision_making_framework.toLowerCase().includes(searchTerm)) ||
                    (profile.communication_style?.tone && typeof profile.communication_style.tone === 'string' && profile.communication_style.tone.toLowerCase().includes(searchTerm)) ||
                    (profile.communication_style?.tone_parsed && profile.communication_style.tone_parsed.some(term => term.toLowerCase().includes(searchTerm))) ||
                    (profile.communication_style?.sentence_structure && typeof profile.communication_style.sentence_structure === 'string' && profile.communication_style.sentence_structure.toLowerCase().includes(searchTerm)) ||
                    (profile.communication_style?.sentence_structure_parsed && profile.communication_style.sentence_structure_parsed.some(structure => structure.toLowerCase().includes(searchTerm))) ||
                    (profile.domain_expertise?.core_competencies && Array.isArray(profile.domain_expertise.core_competencies) && profile.domain_expertise.core_competencies.some(comp => comp.toLowerCase().includes(searchTerm))) ||
                    (profile.background_context?.experience_level && typeof profile.background_context.experience_level === 'string' && profile.background_context.experience_level.toLowerCase().includes(searchTerm)) ||
                    (profile.background_context?.typical_career_path && profile.background_context.typical_career_path.toLowerCase().includes(searchTerm)) ||
                    (profile.behavioral_patterns?.work_style && profile.behavioral_patterns.work_style.toLowerCase().includes(searchTerm)) ||
                    (profile.behavioral_patterns?.work_style_parsed && profile.behavioral_patterns.work_style_parsed.some(style => style.toLowerCase().includes(searchTerm))) ||
                    (profile.behavioral_patterns?.problem_solving_approach && profile.behavioral_patterns.problem_solving_approach.toLowerCase().includes(searchTerm)) ||
                    (profile.behavioral_patterns?.problem_solving_approach_parsed && profile.behavioral_patterns.problem_solving_approach_parsed.some(approach => approach.toLowerCase().includes(searchTerm))) ||
                    (profile.unique_identifiers?.signature_methodologies && Array.isArray(profile.unique_identifiers.signature_methodologies) && profile.unique_identifiers.signature_methodologies.some(method => method.toLowerCase().includes(searchTerm))) ||
                    (profile.unique_identifiers?.contrarian_beliefs && Array.isArray(profile.unique_identifiers.contrarian_beliefs) && profile.unique_identifiers.contrarian_beliefs.some(belief => belief.toLowerCase().includes(searchTerm))) ||
                    (profile.unique_identifiers?.pet_peeves && Array.isArray(profile.unique_identifiers.pet_peeves) && profile.unique_identifiers.pet_peeves.some(peeve => peeve.toLowerCase().includes(searchTerm))) ||
                    (profile.unique_identifiers?.aspirational_references && Array.isArray(profile.unique_identifiers.aspirational_references) && profile.unique_identifiers.aspirational_references.some(ref => ref.toLowerCase().includes(searchTerm))) ||
                    (profile.unique_identifiers?.distinctive_quirks && Array.isArray(profile.unique_identifiers.distinctive_quirks) && profile.unique_identifiers.distinctive_quirks.some(quirk => quirk.toLowerCase().includes(searchTerm))) ||
                    // New category search fields
                    (profile.temporal_context?.career_evolution && profile.temporal_context.career_evolution.toLowerCase().includes(searchTerm)) ||
                    (profile.temporal_context?.career_evolution_parsed && profile.temporal_context.career_evolution_parsed.some(evolution => evolution.toLowerCase().includes(searchTerm))) ||
                    (profile.temporal_context?.influence_timeline && profile.temporal_context.influence_timeline.toLowerCase().includes(searchTerm)) ||
                    (profile.temporal_context?.influence_timeline_parsed && profile.temporal_context.influence_timeline_parsed.some(timeline => timeline.toLowerCase().includes(searchTerm))) ||
                    (profile.temporal_context?.legacy_impact && profile.temporal_context.legacy_impact.toLowerCase().includes(searchTerm)) ||
                    (profile.temporal_context?.legacy_impact_parsed && profile.temporal_context.legacy_impact_parsed.some(impact => impact.toLowerCase().includes(searchTerm))) ||
                    (profile.collaboration?.leadership_style && profile.collaboration.leadership_style.toLowerCase().includes(searchTerm)) ||
                    (profile.collaboration?.leadership_style_parsed && profile.collaboration.leadership_style_parsed.some(style => style.toLowerCase().includes(searchTerm))) ||
                    (profile.collaboration?.team_dynamics && profile.collaboration.team_dynamics.toLowerCase().includes(searchTerm)) ||
                    (profile.collaboration?.team_dynamics_parsed && profile.collaboration.team_dynamics_parsed.some(dynamic => dynamic.toLowerCase().includes(searchTerm))) ||
                    (profile.collaboration?.mentorship_approach && profile.collaboration.mentorship_approach.toLowerCase().includes(searchTerm)) ||
                    (profile.collaboration?.mentorship_approach_parsed && profile.collaboration.mentorship_approach_parsed.some(approach => approach.toLowerCase().includes(searchTerm))) ||
                    (profile.collaboration?.conflict_resolution && profile.collaboration.conflict_resolution.toLowerCase().includes(searchTerm)) ||
                    (profile.collaboration?.conflict_resolution_parsed && profile.collaboration.conflict_resolution_parsed.some(resolution => resolution.toLowerCase().includes(searchTerm))) ||
                    (profile.cultural_context?.cultural_background && profile.cultural_context.cultural_background.toLowerCase().includes(searchTerm)) ||
                    (profile.cultural_context?.cultural_background_parsed && profile.cultural_context.cultural_background_parsed.some(background => background.toLowerCase().includes(searchTerm))) ||
                    (profile.cultural_context?.geographic_influence && profile.cultural_context.geographic_influence.toLowerCase().includes(searchTerm)) ||
                    (profile.cultural_context?.generational_perspective && profile.cultural_context.generational_perspective.toLowerCase().includes(searchTerm)) ||
                    (profile.practical_application?.decision_speed && profile.practical_application.decision_speed.toLowerCase().includes(searchTerm)) ||
                    (profile.practical_application?.decision_speed_parsed && profile.practical_application.decision_speed_parsed.some(speed => speed.toLowerCase().includes(searchTerm))) ||
                    (profile.practical_application?.risk_tolerance && profile.practical_application.risk_tolerance.toLowerCase().includes(searchTerm)) ||
                    (profile.practical_application?.innovation_vs_optimization && profile.practical_application.innovation_vs_optimization.toLowerCase().includes(searchTerm)) ||
                    (profile.practical_application?.scale_preferences && profile.practical_application.scale_preferences.toLowerCase().includes(searchTerm)) ||
                    (profile.communication?.audience_adaptation && profile.communication.audience_adaptation.toLowerCase().includes(searchTerm)) ||
                    (profile.communication?.audience_adaptation_parsed && profile.communication.audience_adaptation_parsed.some(adaptation => adaptation.toLowerCase().includes(searchTerm))) ||
                    (profile.communication?.media_preferences && profile.communication.media_preferences.toLowerCase().includes(searchTerm)) ||
                    (profile.communication?.influence_strategies && profile.communication.influence_strategies.toLowerCase().includes(searchTerm)) ||
                    (profile.learning?.learning_style && profile.learning.learning_style.toLowerCase().includes(searchTerm)) ||
                    (profile.learning?.learning_style_parsed && profile.learning.learning_style_parsed.some(style => style.toLowerCase().includes(searchTerm))) ||
                    (profile.learning?.adaptation_speed && profile.learning.adaptation_speed.toLowerCase().includes(searchTerm)) ||
                    (profile.learning?.failure_response && profile.learning.failure_response.toLowerCase().includes(searchTerm)) ||
                    (profile.values?.core_values && typeof profile.values.core_values === 'string' && profile.values.core_values.toLowerCase().includes(searchTerm)) ||
                    (profile.values?.core_values_parsed && profile.values.core_values_parsed.some(value => value.toLowerCase().includes(searchTerm))) ||
                    (profile.values?.ethical_framework && profile.values.ethical_framework.toLowerCase().includes(searchTerm)) ||
                    (profile.values?.social_responsibility && profile.values.social_responsibility.toLowerCase().includes(searchTerm));

                // Filter by archetype
                let matchesArchetype = selectedArchetypes.length === 0 || selectedArchetypes.includes(profile.archetype);

                // Filter by domain
                let matchesDomain = selectedDomains.length === 0 || selectedDomains.includes(profile.domain);

                // Filter by subdomain
                let matchesSubdomain = selectedSubDomains.length === 0 || selectedSubDomains.includes(profile.sub_domain);

                // Filter by psychological traits
                let matchesTraits = selectedTraits.length === 0 || 
                    selectedTraits.some(trait => Array.isArray(profile.psychological_profile?.primary_traits) && profile.psychological_profile.primary_traits.includes(trait));

                // Filter by communication style
                let matchesCommunication = selectedCommunication.length === 0 || 
                    selectedCommunication.some(style => Array.isArray(profile.communication_style?.tone_parsed) && profile.communication_style.tone_parsed.includes(style));

                // Filter by sentence structure
                let matchesSentenceStructure = selectedSentenceStructure.length === 0 || 
                    selectedSentenceStructure.some(structure => Array.isArray(profile.communication_style?.sentence_structure_parsed) && profile.communication_style.sentence_structure_parsed.includes(structure));

                // Filter by expertise
                let matchesExpertise = selectedExpertise.length === 0 || 
                    selectedExpertise.some(expertise => Array.isArray(profile.domain_expertise?.core_competencies) && profile.domain_expertise.core_competencies.includes(expertise));

                // Filter by background
                let matchesBackground = selectedBackground.length === 0 || 
                    selectedBackground.includes(profile.background_context?.experience_level);

                // Filter by behavior
                let matchesBehavior = selectedBehavior.length === 0 || 
                    selectedBehavior.some(style => Array.isArray(profile.behavioral_patterns?.work_style_parsed) && profile.behavioral_patterns.work_style_parsed.includes(style));

                // Filter by problem solving approach
                let matchesProblemSolving = selectedProblemSolving.length === 0 || 
                    selectedProblemSolving.some(approach => Array.isArray(profile.behavioral_patterns?.problem_solving_approach_parsed) && profile.behavioral_patterns.problem_solving_approach_parsed.includes(approach));

                // Filter by identifiers
                let matchesIdentifiers = selectedIdentifiers.length === 0 || 
                    selectedIdentifiers.some(identifier => Array.isArray(profile.unique_identifiers?.signature_methodologies) && profile.unique_identifiers.signature_methodologies.includes(identifier));

                // New category filters
                let matchesTemporal = selectedTemporal.length === 0 || 
                    selectedTemporal.some(evolution => Array.isArray(profile.temporal_context?.career_evolution_parsed) && profile.temporal_context.career_evolution_parsed.includes(evolution));

                let matchesCollaboration = selectedCollaboration.length === 0 || 
                    selectedCollaboration.some(style => Array.isArray(profile.collaboration?.leadership_style_parsed) && profile.collaboration.leadership_style_parsed.includes(style));

                let matchesCultural = selectedCultural.length === 0 || 
                    selectedCultural.some(background => Array.isArray(profile.cultural_context?.cultural_background_parsed) && profile.cultural_context.cultural_background_parsed.includes(background));

                let matchesPractical = selectedPractical.length === 0 || 
                    selectedPractical.some(speed => Array.isArray(profile.practical_application?.decision_speed_parsed) && profile.practical_application.decision_speed_parsed.includes(speed));

                let matchesCommunicationNew = selectedCommunicationNew.length === 0 || 
                    selectedCommunicationNew.includes(profile.communication?.audience_adaptation);

                let matchesLearning = selectedLearning.length === 0 || 
                    selectedLearning.some(style => Array.isArray(profile.learning?.learning_style_parsed) && profile.learning.learning_style_parsed.includes(style));

                let matchesValues = selectedValues.length === 0 || 
                    selectedValues.some(value => Array.isArray(profile.values?.core_values_parsed) && profile.values.core_values_parsed.includes(value));

                // Behavioral Humanism filters
                // bias_awareness.primary_biases
                let matchesBiasAwareness = selectedBiasAwareness.length === 0 || 
                    selectedBiasAwareness.some(bias => {
                        const value = profile.bias_awareness?.primary_biases;
                        if (!value) return false;
                        if (typeof value === 'string') {
                            return value.toLowerCase().includes(bias.toLowerCase());
                        }
                        return false;
                    });

                // growth_motivation.intrinsic_drivers
                let matchesGrowthMotivation = selectedGrowthMotivation.length === 0 || 
                    selectedGrowthMotivation.some(motivation => {
                        const value = profile.growth_motivation?.intrinsic_drivers;
                        if (!value) return false;
                        if (typeof value === 'string') {
                            return value.toLowerCase().includes(motivation.toLowerCase());
                        }
                        return false;
                    });

                // cognitive_humanism.empathy_expression
                let matchesCognitiveHumanism = selectedCognitiveHumanism.length === 0 || 
                    selectedCognitiveHumanism.some(pattern => {
                        const value = profile.cognitive_humanism?.empathy_expression;
                        if (!value) return false;
                        if (typeof value === 'string') {
                            return value.toLowerCase().includes(pattern.toLowerCase());
                        }
                        return false;
                    });

                // humanistic_cognition.creative_problem_solving
                let matchesHumanisticCognition = selectedHumanisticCognition.length === 0 || 
                    selectedHumanisticCognition.some(value => {
                        const fieldValue = profile.humanistic_cognition?.creative_problem_solving;
                        if (!fieldValue) return false;
                        if (typeof fieldValue === 'string') {
                            return fieldValue.toLowerCase().includes(value.toLowerCase());
                        }
                        return false;
                    });

                // human_needs_hierarchy.need_priorities
                let matchesHumanNeedsHierarchy = selectedHumanNeedsHierarchy.length === 0 || 
                    selectedHumanNeedsHierarchy.some(need => {
                        const value = profile.human_needs_hierarchy?.need_priorities;
                        if (!value) return false;
                        if (typeof value === 'string') {
                            return value.toLowerCase().includes(need.toLowerCase());
                        }
                        return false;
                    });

                // self_actualization_indicators.peak_experiences
                let matchesSelfActualization = selectedSelfActualization.length === 0 || 
                    selectedSelfActualization.some(indicator => {
                        const value = profile.self_actualization_indicators?.peak_experiences;
                        if (!value) return false;
                        if (typeof value === 'string') {
                            return value.toLowerCase().includes(indicator.toLowerCase());
                        }
                        return false;
                    });

                // behavioral_growth.adaptation_patterns
                let matchesBehavioralGrowth = selectedBehavioralGrowth.length === 0 || 
                    selectedBehavioralGrowth.some(pattern => {
                        const value = profile.behavioral_growth?.adaptation_patterns;
                        if (!value) return false;
                        if (typeof value === 'string') {
                            return value.toLowerCase().includes(pattern.toLowerCase());
                        }
                        return false;
                    });

                // Tier 1 Expansion: Technology Relationship filters
                // technology_relationship.technology_adoption
                let matchesTechnology = selectedTechnology.length === 0 || 
                    selectedTechnology.some(tech => {
                        const value = profile.technology_relationship?.technology_adoption;
                        if (!value) return false;
                        if (typeof value === 'string') {
                            return value.toLowerCase().includes(tech.toLowerCase());
                        }
                        return false;
                    });

                // crisis_response.stress_response_pattern
                let matchesCrisisResponse = selectedCrisisResponse.length === 0 || 
                    selectedCrisisResponse.some(crisis => {
                        const value = profile.crisis_response?.stress_response_pattern;
                        if (!value) return false;
                        if (typeof value === 'string') {
                            return value.toLowerCase().includes(crisis.toLowerCase());
                        }
                        return false;
                    });

                // influence_style.persuasion_approach
                let matchesInfluenceStyle = selectedInfluenceStyle.length === 0 || 
                    selectedInfluenceStyle.some(influence => {
                        const value = profile.influence_style?.persuasion_approach;
                        if (!value) return false;
                        if (typeof value === 'string') {
                            return value.toLowerCase().includes(influence.toLowerCase());
                        }
                        return false;
                    });

                // Only apply filters that have actual selections
                let passesAllFilters = true;
                
                if (searchTerm) passesAllFilters = passesAllFilters && matchesSearch;
                if (selectedArchetypes.length > 0) passesAllFilters = passesAllFilters && matchesArchetype;
                if (selectedDomains.length > 0) passesAllFilters = passesAllFilters && matchesDomain;
                if (selectedSubDomains.length > 0) passesAllFilters = passesAllFilters && matchesSubdomain;
                if (selectedTraits.length > 0) passesAllFilters = passesAllFilters && matchesTraits;
                if (selectedCommunication.length > 0) passesAllFilters = passesAllFilters && matchesCommunication;
                if (selectedSentenceStructure.length > 0) passesAllFilters = passesAllFilters && matchesSentenceStructure;
                if (selectedExpertise.length > 0) passesAllFilters = passesAllFilters && matchesExpertise;
                if (selectedBackground.length > 0) passesAllFilters = passesAllFilters && matchesBackground;
                if (selectedBehavior.length > 0) passesAllFilters = passesAllFilters && matchesBehavior;
                if (selectedProblemSolving.length > 0) passesAllFilters = passesAllFilters && matchesProblemSolving;
                if (selectedIdentifiers.length > 0) passesAllFilters = passesAllFilters && matchesIdentifiers;
                if (selectedTemporal.length > 0) passesAllFilters = passesAllFilters && matchesTemporal;
                if (selectedCollaboration.length > 0) passesAllFilters = passesAllFilters && matchesCollaboration;
                if (selectedCultural.length > 0) passesAllFilters = passesAllFilters && matchesCultural;
                if (selectedPractical.length > 0) passesAllFilters = passesAllFilters && matchesPractical;
                if (selectedCommunicationNew.length > 0) passesAllFilters = passesAllFilters && matchesCommunicationNew;
                if (selectedLearning.length > 0) passesAllFilters = passesAllFilters && matchesLearning;
                if (selectedValues.length > 0) passesAllFilters = passesAllFilters && matchesValues;
                if (selectedBiasAwareness.length > 0) passesAllFilters = passesAllFilters && matchesBiasAwareness;
                if (selectedGrowthMotivation.length > 0) passesAllFilters = passesAllFilters && matchesGrowthMotivation;
                if (selectedCognitiveHumanism.length > 0) passesAllFilters = passesAllFilters && matchesCognitiveHumanism;
                if (selectedHumanisticCognition.length > 0) passesAllFilters = passesAllFilters && matchesHumanisticCognition;
                if (selectedHumanNeedsHierarchy.length > 0) passesAllFilters = passesAllFilters && matchesHumanNeedsHierarchy;
                if (selectedSelfActualization.length > 0) passesAllFilters = passesAllFilters && matchesSelfActualization;
                if (selectedBehavioralGrowth.length > 0) passesAllFilters = passesAllFilters && matchesBehavioralGrowth;
                if (selectedTechnology.length > 0) passesAllFilters = passesAllFilters && matchesTechnology;
                if (selectedCrisisResponse.length > 0) passesAllFilters = passesAllFilters && matchesCrisisResponse;
                if (selectedInfluenceStyle.length > 0) passesAllFilters = passesAllFilters && matchesInfluenceStyle;
                
                return passesAllFilters;
            });

            // Sort filtered results alphabetically by last name
            filteredProfiles.sort((a, b) => getLastName(a.name).localeCompare(getLastName(b.name)));
            
            // 🚀 PERFORMANCE: Store in cache (limit cache size to last 10 filter states)
            if (filterCache.size > 10) {
                const firstKey = filterCache.keys().next().value;
                filterCache.delete(firstKey);
            }
            filterCache.set(filterState, filteredProfiles.slice()); // Store copy
            lastFilterState = filterState;
            
            // Update quick navigation stats
            updateQuickNavigationStats();
            
            displayProfiles();
            console.timeEnd('⚡ filterProfiles');
        }

        // Event listeners removed - buttons now use onclick attributes

        // Initialize view
        currentView = 'grid';

        function displayProfiles() {
            console.log('🔄 displayProfiles called with', filteredProfiles.length, 'profiles');
            
            const container = document.getElementById('profiles-container');
            // Count elements removed in new layout - counts now shown in navigation

            // Remove loading message
            const loadingElement = container.querySelector('.loading');
            if (loadingElement) {
                console.log('✓ Removing loading message');
                loadingElement.remove();
            }

            // Count updates removed - counts now handled in navigation
            
            // Update navigation count display
            const visibleCountNav = document.getElementById('visible-count-nav');
            if (visibleCountNav) visibleCountNav.textContent = filteredProfiles.length;
            const totalCountNav = document.getElementById('total-count-nav');
            if (totalCountNav) totalCountNav.textContent = allProfiles.length;

            if (filteredProfiles.length === 0) {
                console.log('⚠️ No profiles to display');
                container.innerHTML = '<div class="no-results">No profiles match the current filters.</div>';
                // Bulk download button removed in new layout
                return;
            }

            console.log('✓ Rendering', filteredProfiles.length, 'profiles in', currentView, 'view');

            const fragment = document.createDocumentFragment();
            
            if (currentView === 'grid') {
                renderGrid(fragment);
            } else {
                renderList(fragment);
            }
            
            container.innerHTML = '';
            container.appendChild(fragment);
            // Bulk download button removed in new layout
            
            console.log('✅ Profiles displayed successfully');
        }

        function renderGrid(fragment) {
            const container = document.getElementById('profiles-container');
            container.className = 'profiles-grid';
            filteredProfiles.forEach(profile => {
                const profileCard = document.createElement('div');
                profileCard.className = 'profile-card';
                profileCard.setAttribute('data-profile-name', profile.name);
                profileCard.onclick = () => toggleProfileSelection(profile.name);
                
                // Generate filename from profile data
                const filename = generateFilename(profile.name);
                
                // Debug subdomain display
                if (profile.name === 'Bill Ackman') {
                    console.log('🔍 Bill Ackman profile data:', profile);
                    console.log('🔍 Bill Ackman sub_domain:', profile.sub_domain);
                    console.log('🔍 Bill Ackman domain:', profile.domain);
                }
                
                profileCard.innerHTML = `
                    <div class="card-header">
                        <div class="card-name-row">
                            <div class="card-name">${profile.name}</div>
                            <div class="card-selected" id="indicator-${profile.name.replace(/\s+/g, '-')}" style="display: none;">SELECTED</div>
                        </div>
                        <div class="card-content">
                            <div class="field-group">
                                <div class="field-label">Archetype</div>
                                <div class="field-value">${profile.archetype}</div>
                            </div>
                            <div class="field-group">
                                <div class="field-label">Domain</div>
                                <div class="field-value">${profile.domain}</div>
                            </div>
                            <div class="field-group">
                                <div class="field-label">Subdomain</div>
                                <div class="field-value">${profile.sub_domain || ''}</div>
                            </div>
                            <div class="field-group profile-traits">
                                <div class="field-label">Primary Traits</div>
                                <div class="traits-list">
                                    ${(() => {
                                        const traits = profile.primary_traits || profile.psychological_profile?.primary_traits;
                                        if (!traits) return '';
                                        const traitArray = Array.isArray(traits) ? traits : traits.split(',').map(t => t.trim());
                                        return traitArray.map(trait => `<span class="trait-tag clickable-badge" onclick="searchByBadge('${trait.replace(/'/g, "\\'")}', event)" title="Click to find other profiles with this trait">${trait}</span>`).join('');
                                    })()}
                                </div>
                            </div>
                        </div>
                        <div class="profile-actions">
                            <a href="profiles/${filename}" class="btn" download onclick="event.stopPropagation()">Download</a>
                            <button class="btn" onclick="copyToClipboard('${filename}'); event.stopPropagation()">Copy</button>
                            <button class="btn" onclick="expandProfile('${profile.name}', event); event.stopPropagation()">Details</button>
                        </div>
                    </div>
                `;
                
                fragment.appendChild(profileCard);
            });
        }

        function renderList(fragment) {
            const container = document.getElementById('profiles-container');
            container.className = 'profiles-list';
            filteredProfiles.forEach(profile => {
                const profileCard = document.createElement('div');
                profileCard.className = 'profile-card';
                profileCard.setAttribute('data-profile-name', profile.name);
                profileCard.onclick = () => toggleProfileSelection(profile.name);
                
                // Generate filename from profile data
                const filename = generateFilename(profile.name);
                
                profileCard.innerHTML = `
                    <div class="profile-name">${profile.name}</div>
                    <div class="profile-archetype">${profile.archetype}</div>
                    <div class="profile-domain">${profile.domain}${profile.sub_domain ? ` - ${profile.sub_domain}` : ''}</div>
                    <div class="profile-actions">
                        <a href="profiles/${filename}" class="btn btn-primary" download onclick="event.stopPropagation()">Download</a>
                        <button class="btn btn-secondary" onclick="copyToClipboard('${filename}'); event.stopPropagation()">Copy</button>
                        <button class="btn btn-secondary" onclick="expandProfile('${profile.name}', event); event.stopPropagation()">Details</button>
                    </div>
                `;
                
                fragment.appendChild(profileCard);
            });
        }

        function copyToClipboard(filename) {
            console.log('🔄 Copying profile:', filename);
            fetch(`profiles/${filename}`)
                .then(response => {
                    console.log('📡 Fetch response:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('📋 Profile data loaded:', data.name);
                    navigator.clipboard.writeText(JSON.stringify(data, null, 2))
                        .then(() => {
                            alert('Profile copied to clipboard!');
                        })
                        .catch((clipError) => {
                            console.error('📋 Clipboard error:', clipError);
                            alert('Failed to copy to clipboard. Please try downloading instead.');
                        });
                })
                .catch(error => {
                    console.error('❌ Error copying profile:', error);
                    alert(`Error copying profile: ${error.message}. Please try downloading instead.`);
                });
        }

        let currentExpandedProfile = null;

        // Calculate relative luminance for a hex color
        function getLuminance(hexColor) {
            // Remove # if present
            const hex = hexColor.replace('#', '');
            
            // Convert to RGB
            const r = parseInt(hex.substr(0, 2), 16) / 255;
            const g = parseInt(hex.substr(2, 2), 16) / 255;
            const b = parseInt(hex.substr(4, 2), 16) / 255;
            
            // Apply sRGB gamma correction
            const rsRGB = r <= 0.03928 ? r / 12.92 : Math.pow((r + 0.055) / 1.055, 2.4);
            const gsRGB = g <= 0.03928 ? g / 12.92 : Math.pow((g + 0.055) / 1.055, 2.4);
            const bsRGB = b <= 0.03928 ? b / 12.92 : Math.pow((b + 0.055) / 1.055, 2.4);
            
            // Calculate relative luminance
            return 0.2126 * rsRGB + 0.7152 * gsRGB + 0.0722 * bsRGB;
        }
        
        // Get appropriate text color based on background luminance
        function getTextColor(bgColor) {
            const luminance = getLuminance(bgColor);
            // WCAG recommends a threshold around 0.5 for optimal contrast
            // Using 0.5 for better readability
            return luminance > 0.5 ? '#000000' : '#FFFFFF';
        }

        // Hierarchical color system for trait categories
        function getTraitColor(category, level = 'primary') {
            const colorSystem = {
                'Background & Experience': {
                    primary: '#8B4513',
                    secondary: '#A0522D',
                    tertiary: '#CD853F',
                    quaternary: '#DEB887'
                },
                'Behavioral Patterns': {
                    primary: '#B8860B',
                    secondary: '#DAA520',
                    tertiary: '#F0E68C',
                    quaternary: '#FFF8DC'
                },
                'Collaboration': {
                    primary: '#006400',
                    secondary: '#228B22',
                    tertiary: '#32CD32',
                    quaternary: '#90EE90'
                },
                'Communication': {
                    primary: '#008B8B',
                    secondary: '#20B2AA',
                    tertiary: '#40E0D0',
                    quaternary: '#AFEEEE'
                },
                'Communication Style': {
                    primary: '#191970',
                    secondary: '#4169E1',
                    tertiary: '#6495ED',
                    quaternary: '#B0C4DE'
                },
                'Cultural Context': {
                    primary: '#4B0082',
                    secondary: '#6A5ACD',
                    tertiary: '#9370DB',
                    quaternary: '#DDA0DD'
                },
                'Domain Expertise': {
                    primary: '#8B008B',
                    secondary: '#9932CC',
                    tertiary: '#BA55D3',
                    quaternary: '#DDA0DD'
                },
                'Learning': {
                    primary: '#800080',
                    secondary: '#9400D3',
                    tertiary: '#DA70D6',
                    quaternary: '#EE82EE'
                },
                'Practical Application': {
                    primary: '#8B0000',
                    secondary: '#DC143C',
                    tertiary: '#F08080',
                    quaternary: '#FFB6C1'
                },
                'Psychological Profile': {
                    primary: '#B22222',
                    secondary: '#DC143C',
                    tertiary: '#F08080',
                    quaternary: '#FFA07A'
                },
                'Temporal Context': {
                    primary: '#FF4500',
                    secondary: '#FF6347',
                    tertiary: '#FF7F50',
                    quaternary: '#FFA500'
                },
                'Unique Identifiers': {
                    primary: '#DAA520',
                    secondary: '#F4A460',
                    tertiary: '#DEB887',
                    quaternary: '#F5DEB3'
                },
                'Values': {
                    primary: '#556B2F',
                    secondary: '#6B8E23',
                    tertiary: '#9ACD32',
                    quaternary: '#ADFF2F'
                }
            };
            
            return colorSystem[category]?.[level] || '#6c757d';
        }

        /**
         * Creates HTML for category cards displayed in the expanded profile modal.
         * 
         * This function generates the detailed view of a profile by:
         * 1. Defining the category structure (20 behavioral categories)
         * 2. Extracting trait data from the profile object
         * 3. Filtering out empty categories and sections
         * 4. Applying hierarchical color coding to trait chips
         * 5. Making trait chips clickable for search functionality
         * 
         * @param {Object} profile - The complete profile object containing all traits
         * @returns {String} HTML string with category cards and trait chips
         */
        function createCategoryCards(profile) {
            // Define all 20 behavioral categories with their respective trait sections
            // Each category contains sections that map to specific fields in the profile data
            const categories = [
                {
                    title: 'Background & Experience',
                    category: 'Background & Experience',
                    sections: [
                        { title: 'EXPERIENCE LEVEL', field: 'background_context.experience_level' },
                        { title: 'CAREER STAGE', field: 'background_context.career_stage' },
                        { title: 'EDUCATIONAL BACKGROUND', field: 'background_context.educational_background' },
                        { title: 'INFERRED OCCUPATIONS', field: 'background_context.wikipedia_enrichment.inferred_occupations' },
                        { title: 'ACHIEVEMENT INDICATORS', field: 'background_context.wikipedia_enrichment.achievement_indicators' },
                        { title: 'INFLUENCE INDICATORS', field: 'background_context.wikipedia_enrichment.influence_indicators' },
                        { title: 'EDUCATION INDICATORS', field: 'background_context.wikipedia_enrichment.education_indicators' },
                        { title: 'SUCCESS METRICS', field: 'background_context.success_metrics' },
                        { title: 'PAIN POINTS', field: 'background_context.pain_points' },
                        { title: 'NOTABLE ACHIEVEMENTS', field: 'background_context.notable_achievements' }
                    ]
                },
                {
                    title: 'Behavioral Patterns',
                    category: 'Behavioral Patterns',
                    sections: [
                        { title: 'WORK STYLE', field: 'behavioral_patterns.work_style' },
                        { title: 'PROBLEM SOLVING APPROACH', field: 'behavioral_patterns.problem_solving_approach' },
                        { title: 'DECISION MAKING', field: 'behavioral_patterns.decision_making' },
                        { title: 'LEARNING PREFERENCES', field: 'behavioral_patterns.learning_preferences' },
                        { title: 'NETWORKING STYLE', field: 'behavioral_patterns.networking_style' },
                        { title: 'CONTENT CONSUMPTION', field: 'behavioral_patterns.content_consumption' }
                    ]
                },
                {
                    title: 'Behavioral Growth',
                    category: 'Behavioral Growth',
                    sections: [
                        { title: 'ADAPTATION PATTERNS', field: 'behavioral_growth.adaptation_patterns' },
                        { title: 'FEEDBACK INTEGRATION', field: 'behavioral_growth.feedback_integration' },
                        { title: 'RESILIENCE INDICATORS', field: 'behavioral_growth.resilience_indicators' }
                    ]
                },
                {
                    title: 'Technology Relationship',
                    category: 'Technology Relationship',
                    sections: [
                        { title: 'TECHNOLOGY ADOPTION', field: 'technology_relationship.technology_adoption' },
                        { title: 'DIGITAL FLUENCY', field: 'technology_relationship.digital_fluency' },
                        { title: 'AI PERSPECTIVE', field: 'technology_relationship.ai_perspective' },
                        { title: 'PLATFORM PREFERENCE', field: 'technology_relationship.platform_preference' },
                        { title: 'TECH INTEGRATION', field: 'technology_relationship.tech_integration' }
                    ]
                },
                {
                    title: 'Crisis Response',
                    category: 'Crisis Response',
                    sections: [
                        { title: 'STRESS RESPONSE PATTERN', field: 'crisis_response.stress_response_pattern' },
                        { title: 'FAILURE RECOVERY', field: 'crisis_response.failure_recovery' },
                        { title: 'UNCERTAINTY TOLERANCE', field: 'crisis_response.uncertainty_tolerance' },
                        { title: 'PRESSURE PERFORMANCE', field: 'crisis_response.pressure_performance' },
                        { title: 'CRISIS LEADERSHIP', field: 'crisis_response.crisis_leadership' }
                    ]
                },
                {
                    title: 'Influence Style',
                    category: 'Influence Style',
                    sections: [
                        { title: 'PERSUASION APPROACH', field: 'influence_style.persuasion_approach' },
                        { title: 'INFLUENCE SCOPE', field: 'influence_style.influence_scope' },
                        { title: 'RHETORIC STYLE', field: 'influence_style.rhetoric_style' },
                        { title: 'CREDIBILITY SOURCE', field: 'influence_style.credibility_source' },
                        { title: 'CHANGE MECHANISM', field: 'influence_style.change_mechanism' }
                    ]
                },
                {
                    title: 'Bias Awareness',
                    category: 'Bias Awareness',
                    sections: [
                        { title: 'DECISION MAKING STYLE', field: 'bias_awareness.decision_making_style' },
                        { title: 'PRIMARY BIASES', field: 'bias_awareness.primary_biases' },
                        { title: 'BIAS MITIGATION STRATEGIES', field: 'bias_awareness.bias_mitigation_strategies' }
                    ]
                },
                {
                    title: 'Cognitive Humanism',
                    category: 'Cognitive Humanism',
                    sections: [
                        { title: 'HUMAN CENTERED THINKING', field: 'cognitive_humanism.human_centered_thinking' },
                        { title: 'ETHICAL FRAMEWORK', field: 'cognitive_humanism.ethical_framework' },
                        { title: 'EMPATHY EXPRESSION', field: 'cognitive_humanism.empathy_expression' }
                    ]
                },
                {
                    title: 'Collaboration',
                    category: 'Collaboration',
                    sections: [
                        { title: 'LEADERSHIP STYLE', field: 'collaboration.leadership_style' },
                        { title: 'TEAM DYNAMICS', field: 'collaboration.team_dynamics' },
                        { title: 'CONFLICT RESOLUTION', field: 'collaboration.conflict_resolution' },
                        { title: 'MENTORSHIP APPROACH', field: 'collaboration.mentorship_approach' },
                        { title: 'LEADERSHIP APPROACH', field: 'collaboration.leadership_approach' }
                    ]
                },
                {
                    title: 'Communication',
                    category: 'Communication',
                    sections: [
                        { title: 'AUDIENCE ADAPTATION', field: 'communication.audience_adaptation' },
                        { title: 'PERSUASION TECHNIQUES', field: 'communication.persuasion_techniques' },
                        { title: 'MEDIA PREFERENCES', field: 'communication.media_preferences' },
                        { title: 'INFLUENCE STRATEGIES', field: 'communication.influence_strategies' },
                        { title: 'MESSAGE CLARITY', field: 'communication.message_clarity' }
                    ]
                },
                {
                    title: 'Communication Style',
                    category: 'Communication Style',
                    sections: [
                        { title: 'VOCABULARY PATTERNS', field: 'communication_style.vocabulary_patterns' },
                        { title: 'TONE', field: 'communication_style.tone' },
                        { title: 'SENTENCE STRUCTURE', field: 'communication_style.sentence_structure' },
                        { title: 'RHETORICAL STRATEGIES', field: 'communication_style.rhetorical_strategies' },
                        { title: 'FORMALITY LEVEL', field: 'communication_style.formality_level' },
                        { title: 'PERSUASION METHODS', field: 'communication_style.persuasion_methods' },
                        { title: 'TYPICAL PHRASES', field: 'communication_style.typical_phrases' },
                        { title: 'RHETORICAL DEVICES', field: 'communication_style.rhetorical_devices' }
                    ]
                },
                {
                    title: 'Cultural Context',
                    category: 'Cultural Context',
                    sections: [
                        { title: 'CULTURAL BACKGROUND', field: 'cultural_context.cultural_background' },
                        { title: 'SOCIETAL INFLUENCE', field: 'cultural_context.societal_influence' },
                        { title: 'GEOGRAPHIC INFLUENCE', field: 'cultural_context.geographic_influence' },
                        { title: 'GENERATIONAL PERSPECTIVE', field: 'cultural_context.generational_perspective' },
                        { title: 'INFLUENCES', field: 'cultural_context.influences' }
                    ]
                },
                {
                    title: 'Domain Expertise',
                    category: 'Domain Expertise',
                    sections: [
                        { title: 'CORE COMPETENCIES', field: 'domain_expertise.core_competencies' },
                        { title: 'SPECIALIZED KNOWLEDGE', field: 'domain_expertise.specialized_knowledge' },
                        { title: 'TOOLS AND PLATFORMS', field: 'domain_expertise.tools_and_platforms' },
                        { title: 'MENTAL MODELS', field: 'domain_expertise.mental_models' },
                        { title: 'REFERENCE FRAMEWORKS', field: 'domain_expertise.reference_frameworks' },
                        { title: 'INDUSTRY KNOWLEDGE', field: 'domain_expertise.industry_knowledge' },
                        { title: 'METHODOLOGIES', field: 'domain_expertise.methodologies' },
                        { title: 'TOOLS TECHNIQUES', field: 'domain_expertise.tools_techniques' }
                    ]
                },
                {
                    title: 'Growth Motivation',
                    category: 'Growth Motivation',
                    sections: [
                        { title: 'LEARNING ORIENTATION', field: 'growth_motivation.learning_orientation' },
                        { title: 'CHALLENGE SEEKING', field: 'growth_motivation.challenge_seeking' },
                        { title: 'INTRINSIC DRIVERS', field: 'growth_motivation.intrinsic_drivers' }
                    ]
                },
                {
                    title: 'Human Needs Hierarchy',
                    category: 'Human Needs Hierarchy',
                    sections: [
                        { title: 'BELONGING EXPRESSION', field: 'human_needs_hierarchy.belonging_expression' },
                        { title: 'ESTEEM SOURCES', field: 'human_needs_hierarchy.esteem_sources' }
                    ]
                },
                {
                    title: 'Humanistic Cognition',
                    category: 'Humanistic Cognition',
                    sections: [
                        { title: 'CREATIVE PROBLEM SOLVING', field: 'humanistic_cognition.creative_problem_solving' },
                        { title: 'HOLISTIC PERSPECTIVE', field: 'humanistic_cognition.holistic_perspective' },
                        { title: 'COLLABORATIVE INTELLIGENCE', field: 'humanistic_cognition.collaborative_intelligence' }
                    ]
                },
                {
                    title: 'Learning',
                    category: 'Learning',
                    sections: [
                        { title: 'LEARNING STYLE', field: 'learning.learning_style' },
                        { title: 'KNOWLEDGE SHARING', field: 'learning.knowledge_sharing' },
                        { title: 'ADAPTATION SPEED', field: 'learning.adaptation_speed' },
                        { title: 'FAILURE RESPONSE', field: 'learning.failure_response' },
                        { title: 'KNOWLEDGE SOURCES', field: 'learning.knowledge_sources' }
                    ]
                },
                {
                    title: 'Practical Application',
                    category: 'Practical Application',
                    sections: [
                        { title: 'DECISION SPEED', field: 'practical_application.decision_speed' },
                        { title: 'RISK TOLERANCE', field: 'practical_application.risk_tolerance' },
                        { title: 'ADAPTABILITY', field: 'practical_application.adaptability' },
                        { title: 'INNOVATION VS OPTIMIZATION', field: 'practical_application.innovation_vs_optimization' },
                        { title: 'SCALE PREFERENCES', field: 'practical_application.scale_preferences' },
                        { title: 'SCALING APPROACH', field: 'practical_application.scaling_approach' }
                    ]
                },
                {
                    title: 'Psychological Profile',
                    category: 'Psychological Profile',
                    sections: [
                        { title: 'PRIMARY TRAITS', field: 'psychological_profile.primary_traits' },
                        { title: 'CORE MOTIVATIONS', field: 'psychological_profile.core_motivations' },
                        { title: 'BEHAVIORAL PATTERNS', field: 'psychological_profile.behavioral_patterns' },
                        { title: 'DECISION MAKING FRAMEWORK', field: 'psychological_profile.decision_making_framework' },
                        { title: 'STRESS RESPONSES', field: 'psychological_profile.stress_responses' },
                        { title: 'BLIND SPOTS', field: 'psychological_profile.blind_spots' },
                        { title: 'LEARNING STYLE', field: 'psychological_profile.learning_style' },
                        { title: 'COGNITIVE STYLE', field: 'psychological_profile.cognitive_style' },
                        { title: 'DECISION MAKING STYLE', field: 'psychological_profile.decision_making_style' }
                    ]
                },
                {
                    title: 'Self Actualization',
                    category: 'Self Actualization',
                    sections: [
                        { title: 'PEAK EXPERIENCES', field: 'self_actualization_indicators.peak_experiences' },
                        { title: 'AUTONOMY EXPRESSION', field: 'self_actualization_indicators.autonomy_expression' },
                        { title: 'PURPOSE ALIGNMENT', field: 'self_actualization_indicators.purpose_alignment' }
                    ]
                },
                {
                    title: 'Temporal Context',
                    category: 'Temporal Context',
                    sections: [
                        { title: 'CAREER EVOLUTION', field: 'temporal_context.career_evolution' },
                        { title: 'INFLUENCE TIMELINE', field: 'temporal_context.influence_timeline' },
                        { title: 'LEGACY IMPACT', field: 'temporal_context.legacy_impact' }
                    ]
                },
                {
                    title: 'Unique Identifiers',
                    category: 'Unique Identifiers',
                    sections: [
                        { title: 'SIGNATURE METHODOLOGIES', field: 'unique_identifiers.signature_methodologies' },
                        { title: 'CONTRARIAN BELIEFS', field: 'unique_identifiers.contrarian_beliefs' },
                        { title: 'PET PEEVES', field: 'unique_identifiers.pet_peeves' },
                        { title: 'ASPIRATIONAL REFERENCES', field: 'unique_identifiers.aspirational_references' },
                        { title: 'DISTINCTIVE QUIRKS', field: 'unique_identifiers.distinctive_quirks' },
                        { title: 'DISTINCTIVE APPROACHES', field: 'unique_identifiers.distinctive_approaches' }
                    ]
                },
                {
                    title: 'Values',
                    category: 'Values',
                    sections: [
                        { title: 'CORE VALUES', field: 'values.core_values' },
                        { title: 'PROFESSIONAL PRINCIPLES', field: 'values.professional_principles' },
                        { title: 'ETHICAL FRAMEWORK', field: 'values.ethical_framework' },
                        { title: 'ETHICAL PRINCIPLES', field: 'values.ethical_principles' },
                        { title: 'SOCIAL RESPONSIBILITY', field: 'values.social_responsibility' }
                    ]
                }
            ];

            /**
             * Helper function to safely access nested object properties using dot notation.
             * Example: getFieldValue(profile, 'communication_style.tone') returns profile.communication_style.tone
             * 
             * @param {Object} obj - The object to query
             * @param {String} path - Dot-notation path to the desired property
             * @returns {*} The value at the specified path, or undefined if not found
             */
            function getFieldValue(obj, path) {
                return path.split('.').reduce((acc, part) => acc?.[part], obj);
            }

            // Initialize HTML string for all category cards
            let html = '';
            
            // Process each category and generate its HTML
            categories.forEach(category => {
                // Step 1: Extract values for all sections and filter out empty ones
                // This ensures we only show sections with actual data
                const populatedSections = category.sections
                    .map(section => {
                        const value = getFieldValue(profile, section.field);
                        return { ...section, value };
                    })
                    .filter(section => {
                        // Filter out sections with no data or empty values
                        if (!section.value) return false;
                        if (Array.isArray(section.value)) return section.value.length > 0;
                        if (typeof section.value === 'string') return section.value.trim() !== '';
                        return true;
                    });

                // Step 2: Skip the entire category if it has no populated sections
                // This prevents empty category cards from appearing in the UI
                if (populatedSections.length === 0) return;

                // Step 3: Generate the category card HTML
                html += `<div class="expanded-category-card">`;
                html += `<div class="expanded-category-header">${category.title}</div>`;
                html += `<div class="expanded-category-content">`;

                // Step 4: Generate HTML for each section within the category
                populatedSections.forEach((section, index) => {
                    // Apply hierarchical color coding (cycles through 4 color levels per category)
                    const levelIndex = index % 4; // Cycle through primary, secondary, tertiary, quaternary
                    const levels = ['primary', 'secondary', 'tertiary', 'quaternary'];
                    const bgColor = getTraitColor(category.category, levels[levelIndex]);
                    const textColor = getTextColor(bgColor); // Ensures WCAG-compliant contrast

                    html += `<div class="expanded-section">`;
                    html += `<div class="expanded-section-title">${section.title}</div>`;
                    html += `<div class="expanded-trait-list">`;

                    // Step 5: Handle different value types (arrays or strings)
                    if (Array.isArray(section.value)) {
                        // For array values: create a clickable trait chip for each item
                        section.value.forEach(item => {
                            html += `<span class="expanded-trait clickable-badge" style="background: ${bgColor}; color: ${textColor};" onclick="searchByBadge('${item.replace(/'/g, "\\'")}', event)">${item}</span>`;
                        });
                    } else if (typeof section.value === 'string') {
                        // For string values: check if comma-separated, split if needed
                        const items = section.value.includes(',') 
                            ? section.value.split(',').map(s => s.trim()).filter(s => s)
                            : [section.value];
                        
                        // Create clickable trait chips for each item
                        items.forEach(item => {
                            // Escape single quotes to prevent JS errors in onclick handler
                            html += `<span class="expanded-trait clickable-badge" style="background: ${bgColor}; color: ${textColor};" onclick="searchByBadge('${item.replace(/'/g, "\\'")}', event)">${item}</span>`;
                        });
                    }

                    html += `</div></div>`; // Close expanded-trait-list and expanded-section
                });

                html += `</div></div>`; // Close expanded-category-content and expanded-category-card
            });

            // Return the complete HTML string for all populated category cards
            return html;
        }

        function expandProfile(profileName, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();
            }
            console.log('🔍 expandProfile called with:', profileName);
            const profile = allProfiles.find(p => p.name === profileName);
            if (!profile) {
                console.error('❌ Profile not found:', profileName);
                console.log('Available profiles:', allProfiles.map(p => p.name).slice(0, 10));
                return;
            }
            console.log('✅ Profile found:', profile.name);

            // Store current profile for copy/download functions
            currentExpandedProfile = profile;

            // Update the expanded profile content
            document.getElementById('expanded-name').textContent = profile.name;
            document.getElementById('expanded-subtitle').textContent = `${profile.archetype} • ${profile.domain}`;
            
            const content = document.getElementById('expanded-content');
            
            
            // Generate HTML using the new category cards function
            content.innerHTML = createCategoryCards(profile);

            // Show the expanded profile
            document.getElementById('expanded-profile').classList.add('show');
            document.body.classList.add('modal-open');
        }

        function closeExpandedProfile() {
            document.getElementById('expanded-profile').classList.remove('show');
            document.body.classList.remove('modal-open');
            currentExpandedProfile = null;
        }

        function openColophon() {
            const modal = document.getElementById('colophon-modal');
            const content = document.getElementById('colophon-content');
            
            if (!modal) {
                console.error('Colophon modal not found');
                return;
            }
            
            // Populate colophon content
            content.innerHTML = `
                <div class="expanded-category-card">
                    <div class="expanded-category-content" style="padding: 20px; line-height: 1.6;">
                        <p><strong>Influence Atlas</strong> is an interactive index of 265 influential figures evaluated through a unique Behavioral Humanism framework that combines insights from Daniel Kahneman's behavioral economics and Abraham Maslow's humanistic psychology.</p>
                        
                        <p style="margin-top: 16px;"><strong>Framework Development:</strong> We developed a comprehensive evaluation system that examines individuals across 21 categories, from cognitive patterns and decision-making styles to growth motivation and self-actualization. This framework integrates Kahneman's understanding of System 1/System 2 thinking, cognitive biases, and heuristics with Maslow's hierarchy of needs and concepts of peak experiences and self-transcendence.</p>
                        
                        <p style="margin-top: 16px;"><strong>Data Integrity Process:</strong> Every profile is built from factually verifiable sources including biographies, interviews, documented speeches, and published works. We employed a rigorous multi-stage validation process:</p>
                        <ul style="margin-top: 8px; margin-left: 20px;">
                            <li>Initial data collection from Wikipedia, Wikidata, and biographical sources</li>
                            <li>Pattern-based analysis to identify behavioral traits and cognitive styles</li>
                            <li>Cross-validation against documented statements and observable behaviors</li>
                            <li>Automated standardization of 3,887 trait instances to ensure consistency</li>
                            <li>Coverage analysis ensuring 90%+ of high-value fields are populated with real data</li>
                            <li>Manual review to eliminate speculation and ensure factual grounding</li>
                        </ul>
                        
                        <p style="margin-top: 16px;"><strong>Technology & Quality:</strong> Built with vanilla JavaScript, HTML5, and CSS3 for maximum performance and accessibility. The interface features hierarchical color-coded traits (WCAG 2.1 AA compliant), multi-dimensional filtering across 7 behavioral dimensions, and comprehensive search. All 265 profiles are available as downloadable JSON, Markdown, and AI agent-formatted files.</p>
                        
                        <p style="margin-top: 16px;"><strong>Repository:</strong> <a href="https://github.com/raymassie/influence-atlas" target="_blank" style="color: #283618; text-decoration: underline;">github.com/raymassie/influence-atlas</a></p>
                        
                        <p style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #ddd; font-size: 0.9em; color: #666;">Built with attention to data integrity, user experience, and accessibility • © 2025 • Version 9.0</p>
                    </div>
                </div>
            `;
            
            modal.classList.add('show');
            document.body.classList.add('modal-open');
        }

        function closeColophon() {
            document.getElementById('colophon-modal').classList.remove('show');
            document.body.classList.remove('modal-open');
        }

        function copyExpandedProfile() {
            if (!currentExpandedProfile) {
                alert('No profile selected');
                return;
            }

            navigator.clipboard.writeText(JSON.stringify(currentExpandedProfile, null, 2))
                .then(() => {
                    alert('Profile copied to clipboard!');
                })
                .catch(() => {
                    alert('Failed to copy to clipboard. Please try downloading instead.');
                });
        }

        function downloadExpandedProfile() {
            if (!currentExpandedProfile) {
                alert('No profile selected');
                return;
            }

            const filename = generateFilename(currentExpandedProfile.name);
            const profileData = JSON.stringify(currentExpandedProfile, null, 2);
            const blob = new Blob([profileData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        // Wait for DOM to be ready before initializing
        console.log('🔄 Script loaded and executing...');
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔄 DOM Content Loaded');
            loadProfiles();
            
            // Add event listeners after DOM is ready
            const compareBtn = document.getElementById('compare-btn');
            const clearComparisonBtn = document.getElementById('clear-comparison-btn');
            const closeComparisonBtn = document.getElementById('close-comparison-btn');
            
            if (compareBtn) compareBtn.addEventListener('click', showComparison);
            if (clearComparisonBtn) clearComparisonBtn.addEventListener('click', clearComparison);
            if (closeComparisonBtn) closeComparisonBtn.addEventListener('click', hideComparison);
            
            // Add colophon button listener
            const colophonBtn = document.getElementById('colophon-btn');
            if (colophonBtn) {
                colophonBtn.addEventListener('click', openColophon);
            }
            
            // Add format radio button listeners
            const formatOptions = document.querySelectorAll('.format-option');
            formatOptions.forEach((option, index) => {
                option.addEventListener('click', () => {
                    // Remove checked class from all radio buttons
                    formatOptions.forEach(opt => {
                        const radioBtn = opt.querySelector('.radio-button');
                        const radioInner = opt.querySelector('.radio-inner');
                        radioBtn.classList.remove('checked');
                        if (radioInner) radioInner.remove();
                    });
                    
                    // Add checked class to clicked radio button
                    const radioBtn = option.querySelector('.radio-button');
                    radioBtn.classList.add('checked');
                    
                    // Add inner circle
                    const radioInner = document.createElement('div');
                    radioInner.className = 'radio-inner';
                    radioBtn.appendChild(radioInner);
                });
            });
        });

        function clearAllFilters() {
            const selects = document.querySelectorAll('select');
            selects.forEach(select => {
                if (select.multiple) {
                    Array.from(select.options).forEach(option => option.selected = false);
                } else {
                    select.selectedIndex = 0;
                }
            });

            document.getElementById('search-filter').value = '';
            activeSuperFilter = null;
            updateSuperFilterButtons();
            
            // Restore all filter options to their original state
            restoreAllFilterOptions();
            filterProfiles();
        }

        function restoreAllFilterOptions() {
            console.log('🔄 Restoring all filter options...');
            
            if (!allProfiles || allProfiles.length === 0) {
                console.log('⚠️ No profiles loaded yet, skipping filter restoration');
                return;
            }
            
            const filters = {
                'archetype-filter': 'archetype',
                'domain-filter': 'domain',
                'subdomain-filter': 'sub_domain',
                'trait-filter': 'psychological_profile.primary_traits',
                'communication-filter': 'communication_style.tone',
                'sentence-structure-filter': 'communication_style.sentence_structure',
                'expertise-filter': 'domain_expertise.core_competencies',
                'background-filter': 'background_context.experience_level',
                'behavior-filter': 'behavioral_patterns.work_style',
                'problem-solving-filter': 'behavioral_patterns.problem_solving_approach',
                'identifier-filter': 'unique_identifiers.signature_methodologies',
                'temporal-filter': 'temporal_context.career_evolution',
                'collaboration-filter': 'collaboration.leadership_style',
                'cultural-filter': 'cultural_context.cultural_background',
                'practical-filter': 'practical_application.decision_speed',
                'communication-new-filter': 'communication.audience_adaptation',
                'learning-filter': 'learning.learning_style',
                'values-filter': 'values.core_values'
            };

            // Restore each filter with all available options from all profiles
            Object.entries(filters).forEach(([filterId, dataPath]) => {
                const filter = document.getElementById(filterId);
                if (!filter) return;

                // Clear existing options
                filter.innerHTML = '';

                // Get all unique values from all profiles for this field
                const allValues = new Set();
                allProfiles.forEach(profile => {
                    const value = getNestedValue(profile, dataPath);
                    if (value) {
                        if (Array.isArray(value)) {
                            value.forEach(v => allValues.add(v));
                        } else {
                            allValues.add(value);
                        }
                    }
                });

                // Add all unique values as options
                Array.from(allValues).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase())).forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    
                    option.textContent = value;
                    
                    filter.appendChild(option);
                });
            });
            
            console.log('✅ All filter options restored');
        }

        function exportFilteredProfiles() {
            if (filteredProfiles.length === 0) {
                alert('No profiles to export.');
                return;
            }

            if (filteredProfiles.length === 1) {
                const profile = filteredProfiles[0];
                const filename = generateFilename(profile.name);
                const link = document.createElement('a');
                link.href = `profiles/${filename}`;
                link.download = filename;
                link.click();
                return;
            }

            const zip = new JSZip();
            
            filteredProfiles.forEach(profile => {
                const filename = generateFilename(profile.name);
                const profileData = JSON.stringify(profile, null, 2);
                zip.file(filename, profileData);
            });

            zip.generateAsync({type: 'blob'}).then(content => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = `profiles-${filteredProfiles.length}-files.zip`;
                link.click();
            });
        }

        let selectedProfiles = [];
        let activeSuperFilter = null;

        // Initialize button states on page load
        updateComparisonUI();

        function toggleProfileSelection(profileName) {
            const index = selectedProfiles.findIndex(p => p.name === profileName);
            const indicator = document.getElementById(`indicator-${profileName.replace(/\s+/g, '-')}`);
            const profileCard = document.querySelector(`[data-profile-name="${profileName}"]`);
            
            if (index === -1) {
                if (selectedProfiles.length >= 3) {
                    alert('You can only select up to 3 profiles for comparison.');
                    return;
                }
                const profile = allProfiles.find(p => p.name === profileName);
                selectedProfiles.push(profile);
                indicator.style.display = 'inline';
                if (profileCard) profileCard.classList.add('selected');
            } else {
                selectedProfiles.splice(index, 1);
                indicator.style.display = 'none';
                if (profileCard) profileCard.classList.remove('selected');
            }
            
            updateComparisonUI();
        }

        function updateComparisonUI() {
            const count = selectedProfiles.length;
            const totalCount = allProfiles.length;
            
            // Update new nav bar elements
            const selectedCountEl = document.getElementById('selected-count');
            const totalCountEl = document.getElementById('total-count');
            const clearBtn = document.getElementById('clear-selections-btn');
            const copyBtn = document.getElementById('copy-selected-btn');
            const downloadBtn = document.getElementById('download-selected-btn');
            
            if (selectedCountEl) selectedCountEl.textContent = count;
            if (totalCountEl) totalCountEl.textContent = totalCount;
            if (clearBtn) clearBtn.disabled = count === 0;
            if (copyBtn) copyBtn.disabled = count === 0;
            if (downloadBtn) downloadBtn.disabled = count === 0;
            
            // Update legacy comparison UI if it exists
            const comparisonCount = document.getElementById('comparison-count');
            const compareBtn = document.getElementById('compare-btn');
            const downloadBtnLegacy = document.getElementById('download-btn');
            const clearBtnLegacy = document.getElementById('clear-btn');
            const comparisonPanel = document.getElementById('comparison-panel');
            
            if (comparisonCount) comparisonCount.textContent = count;
            if (compareBtn) compareBtn.disabled = count < 2;
            if (downloadBtnLegacy) downloadBtnLegacy.disabled = count === 0;
            if (clearBtnLegacy) clearBtnLegacy.disabled = count === 0;
            
            if (comparisonPanel) {
                if (count > 0) {
                    comparisonPanel.classList.add('show');
                } else {
                    comparisonPanel.classList.remove('show');
                }
            }
        }

        function showComparison() {
            const content = document.getElementById('comparison-content');
            content.innerHTML = selectedProfiles.map(profile => `
                <div class="comparison-profile">
                    <h4>${profile.name}</h4>
                    <p><strong>Archetype:</strong> ${profile.archetype}</p>
                    <p><strong>Domain:</strong> ${profile.domain}</p>
                    <p><strong>Name:</strong> ${profile.name}</p>
                </div>
            `).join('');
        }

        function clearComparison() {
            selectedProfiles = [];
            document.querySelectorAll('.card-selected').forEach(indicator => {
                indicator.style.display = 'none';
            });
            document.querySelectorAll('.profile-card').forEach(card => {
                card.classList.remove('selected');
            });
            updateComparisonUI();
        }

        function hideComparison() {
            document.getElementById('comparison-panel').classList.remove('show');
        }

        // Toggle filters on mobile
        function toggleFilters() {
            const filters = document.querySelector('.filters');
            const toggleBtn = document.querySelector('.mobile-menu-toggle');
            
            if (filters.classList.contains('show')) {
                filters.classList.remove('show');
                toggleBtn.textContent = '☰ Filters';
            } else {
                filters.classList.add('show');
                toggleBtn.textContent = '✕ Close';
            }
        }

        // Toggle view between grid and list
        function toggleView() {
            const desktopBtn = document.querySelector('.desktop-nav .view-toggle-single');
            if (currentView === 'grid') {
                currentView = 'list';
                if (desktopBtn) {
                    desktopBtn.textContent = 'List View';
                    desktopBtn.className = 'view-toggle-single list-view';
                }
            } else {
                currentView = 'grid';
                if (desktopBtn) {
                    desktopBtn.textContent = 'Grid View';
                    desktopBtn.className = 'view-toggle-single grid-view';
                }
            }
            
            displayProfiles();
        }

        function toggleFilter(filterId) {
            const content = document.getElementById(filterId + '-content');
            const header = content.previousElementSibling;
            const icon = header.querySelector('.filter-icon');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                icon.textContent = '+';
            } else {
                content.classList.add('active');
                icon.textContent = '−';
            }
        }

        function clearSelections() {
            clearComparison();
        }

        function getSelectedFormat() {
            // Check which radio button is selected
            const formatOptions = document.querySelectorAll('.format-option');
            for (let i = 0; i < formatOptions.length; i++) {
                const option = formatOptions[i];
                if (option.querySelector('.radio-button').classList.contains('checked')) {
                    const label = option.querySelector('label').textContent.toLowerCase();
                    return label;
                }
            }
            return 'markdown'; // default
        }

        function formatProfileForExport(profile, format) {
            if (format === 'json') {
                return JSON.stringify(profile, null, 2);
            } else if (format === 'agent') {
                // Agent format - simplified text format for AI agents
                let output = `# ${profile.name}\n\n`;
                output += `**Archetype:** ${profile.archetype}\n`;
                output += `**Domain:** ${profile.domain}\n`;
                if (profile.sub_domain) output += `**Subdomain:** ${profile.sub_domain}\n`;
                output += `\n## Profile Data\n\n`;
                output += '```json\n';
                output += JSON.stringify(profile, null, 2);
                output += '\n```\n';
                return output;
            } else {
                // Markdown format (default)
                let output = `# ${profile.name}\n\n`;
                output += `**Archetype:** ${profile.archetype}\n`;
                output += `**Domain:** ${profile.domain}\n`;
                if (profile.sub_domain) output += `**Subdomain:** ${profile.sub_domain}\n`;
                
                // Add primary traits if available
                const traits = profile.primary_traits || profile.psychological_profile?.primary_traits;
                if (traits) {
                    const traitArray = Array.isArray(traits) ? traits : traits.split(',').map(t => t.trim());
                    output += `\n**Primary Traits:** ${traitArray.join(', ')}\n`;
                }
                
                return output;
            }
        }

        function copySelected() {
            if (selectedProfiles.length === 0) return;
            
            const format = getSelectedFormat();
            let content = '';
            
            if (format === 'json') {
                // For JSON, export as array
                content = JSON.stringify(selectedProfiles, null, 2);
            } else {
                // For markdown and agent, concatenate individual profiles
                content = selectedProfiles.map(p => formatProfileForExport(p, format)).join('\n\n---\n\n');
            }
            
            // Copy to clipboard
            navigator.clipboard.writeText(content).then(() => {
                // Show feedback
                const copyBtn = document.getElementById('copy-selected-btn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'COPIED!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            });
        }

        function downloadSelected() {
            if (selectedProfiles.length === 0) return;
            
            const format = getSelectedFormat();
            let content = '';
            let filename = '';
            let mimeType = 'text/plain';
            
            if (format === 'json') {
                content = JSON.stringify(selectedProfiles, null, 2);
                filename = `selected-profiles-${selectedProfiles.length}.json`;
                mimeType = 'application/json';
            } else if (format === 'agent') {
                content = selectedProfiles.map(p => formatProfileForExport(p, format)).join('\n\n---\n\n');
                filename = `selected-profiles-${selectedProfiles.length}-agent.md`;
                mimeType = 'text/markdown';
            } else {
                content = selectedProfiles.map(p => formatProfileForExport(p, format)).join('\n\n---\n\n');
                filename = `selected-profiles-${selectedProfiles.length}.md`;
                mimeType = 'text/markdown';
            }
            
            // Create blob and download
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
